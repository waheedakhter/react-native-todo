fc45eb31a383479d1d5e292d38e7f3b1
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

function _vm() {
  var data = require('vm');

  _vm = function _vm() {
    return data;
  };

  return data;
}

function _fakeTimers() {
  var data = require('@jest/fake-timers');

  _fakeTimers = function _fakeTimers() {
    return data;
  };

  return data;
}

function _jestMock() {
  var data = require('jest-mock');

  _jestMock = function _jestMock() {
    return data;
  };

  return data;
}

function _jestUtil() {
  var data = require('jest-util');

  _jestUtil = function _jestUtil() {
    return data;
  };

  return data;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

var NodeEnvironment = function () {
  function NodeEnvironment(config) {
    (0, _classCallCheck2.default)(this, NodeEnvironment);

    _defineProperty(this, 'context', void 0);

    _defineProperty(this, 'fakeTimers', void 0);

    _defineProperty(this, 'fakeTimersModern', void 0);

    _defineProperty(this, 'global', void 0);

    _defineProperty(this, 'moduleMocker', void 0);

    this.context = (0, _vm().createContext)();
    var global = this.global = (0, _vm().runInContext)('this', (0, _extends2.default)(this.context, config.testEnvironmentOptions));
    global.global = global;
    global.clearInterval = clearInterval;
    global.clearTimeout = clearTimeout;
    global.setInterval = setInterval;
    global.setTimeout = setTimeout;
    global.Buffer = Buffer;
    global.setImmediate = setImmediate;
    global.clearImmediate = clearImmediate;
    global.ArrayBuffer = ArrayBuffer;
    global.Uint8Array = Uint8Array;

    if (typeof URL !== 'undefined' && typeof URLSearchParams !== 'undefined') {
      global.URL = URL;
      global.URLSearchParams = URLSearchParams;
    }

    if (typeof TextEncoder !== 'undefined' && typeof TextDecoder !== 'undefined') {
      global.TextEncoder = TextEncoder;
      global.TextDecoder = TextDecoder;
    }

    if (typeof queueMicrotask !== 'undefined') {
      global.queueMicrotask = queueMicrotask;
    }

    if (typeof AbortController !== 'undefined') {
      global.AbortController = AbortController;
    }

    if (typeof AbortSignal !== 'undefined') {
      global.AbortSignal = AbortSignal;
    }

    if (typeof Event !== 'undefined') {
      global.Event = Event;
    }

    if (typeof EventTarget !== 'undefined') {
      global.EventTarget = EventTarget;
    }

    if (typeof performance !== 'undefined') {
      global.performance = performance;
    }

    (0, _jestUtil().installCommonGlobals)(global, config.globals);
    this.moduleMocker = new (_jestMock().ModuleMocker)(global);

    var timerIdToRef = function timerIdToRef(id) {
      return {
        id: id,
        ref: function ref() {
          return this;
        },
        unref: function unref() {
          return this;
        }
      };
    };

    var timerRefToId = function timerRefToId(timer) {
      return timer && timer.id || undefined;
    };

    var timerConfig = {
      idToRef: timerIdToRef,
      refToId: timerRefToId
    };
    this.fakeTimers = new (_fakeTimers().LegacyFakeTimers)({
      config: config,
      global: global,
      moduleMocker: this.moduleMocker,
      timerConfig: timerConfig
    });
    this.fakeTimersModern = new (_fakeTimers().ModernFakeTimers)({
      config: config,
      global: global
    });
  }

  (0, _createClass2.default)(NodeEnvironment, [{
    key: "setup",
    value: function setup() {
      return _regenerator.default.async(function setup$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
            case "end":
              return _context.stop();
          }
        }
      }, null, null, null, Promise);
    }
  }, {
    key: "teardown",
    value: function teardown() {
      return _regenerator.default.async(function teardown$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              if (this.fakeTimers) {
                this.fakeTimers.dispose();
              }

              if (this.fakeTimersModern) {
                this.fakeTimersModern.dispose();
              }

              this.context = null;
              this.fakeTimers = null;
              this.fakeTimersModern = null;

            case 5:
            case "end":
              return _context2.stop();
          }
        }
      }, null, this, null, Promise);
    }
  }, {
    key: "getVmContext",
    value: function getVmContext() {
      return this.context;
    }
  }]);
  return NodeEnvironment;
}();

module.exports = NodeEnvironment;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIl92bSIsImRhdGEiLCJyZXF1aXJlIiwiX2Zha2VUaW1lcnMiLCJfamVzdE1vY2siLCJfamVzdFV0aWwiLCJfZGVmaW5lUHJvcGVydHkiLCJvYmoiLCJrZXkiLCJ2YWx1ZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImNvbmZpZ3VyYWJsZSIsIndyaXRhYmxlIiwiTm9kZUVudmlyb25tZW50IiwiY29uZmlnIiwiY29udGV4dCIsImNyZWF0ZUNvbnRleHQiLCJnbG9iYWwiLCJydW5JbkNvbnRleHQiLCJ0ZXN0RW52aXJvbm1lbnRPcHRpb25zIiwiY2xlYXJJbnRlcnZhbCIsImNsZWFyVGltZW91dCIsInNldEludGVydmFsIiwic2V0VGltZW91dCIsIkJ1ZmZlciIsInNldEltbWVkaWF0ZSIsImNsZWFySW1tZWRpYXRlIiwiQXJyYXlCdWZmZXIiLCJVaW50OEFycmF5IiwiVVJMIiwiVVJMU2VhcmNoUGFyYW1zIiwiVGV4dEVuY29kZXIiLCJUZXh0RGVjb2RlciIsInF1ZXVlTWljcm90YXNrIiwiQWJvcnRDb250cm9sbGVyIiwiQWJvcnRTaWduYWwiLCJFdmVudCIsIkV2ZW50VGFyZ2V0IiwicGVyZm9ybWFuY2UiLCJpbnN0YWxsQ29tbW9uR2xvYmFscyIsImdsb2JhbHMiLCJtb2R1bGVNb2NrZXIiLCJNb2R1bGVNb2NrZXIiLCJ0aW1lcklkVG9SZWYiLCJpZCIsInJlZiIsInVucmVmIiwidGltZXJSZWZUb0lkIiwidGltZXIiLCJ1bmRlZmluZWQiLCJ0aW1lckNvbmZpZyIsImlkVG9SZWYiLCJyZWZUb0lkIiwiZmFrZVRpbWVycyIsIkxlZ2FjeUZha2VUaW1lcnMiLCJmYWtlVGltZXJzTW9kZXJuIiwiTW9kZXJuRmFrZVRpbWVycyIsImRpc3Bvc2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7O0FBRUEsU0FBU0EsR0FBVCxHQUFlO0FBQ2IsTUFBTUMs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QUFBQTtBQUFBO0FBQUE7QUFBQTs7O1dBRUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUNFLGtCQUFJLEtBQUtvQyxVQUFULEVBQXFCO0FBQ25CLHFCQUFLQSxVQUFMLENBQWdCSSxPQUFoQjtBQUNEOztBQUVELGtCQUFJLEtBQUtGLGdCQUFULEVBQTJCO0FBQ3pCLHFCQUFLQSxnQkFBTCxDQUFzQkUsT0FBdEI7QUFDRDs7QUFFRCxtQkFBSzFDLE9BQUwsR0FBZSxJQUFmO0FBQ0EsbUJBQUtzQyxVQUFMLEdBQWtCLElBQWxCO0FBQ0EsbUJBQUtFLGdCQUFMLEdBQXdCLElBQXhCOztBQVhGO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOzs7V0FjQSx3QkFBZTtBQUNiLGFBQU8sS0FBS3hDLE9BQVo7QUFDRDs7Ozs7QUFHSDJDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjlDLGVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5mdW5jdGlvbiBfdm0oKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKCd2bScpO1xuXG4gIF92bSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX2Zha2VUaW1lcnMoKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKCdAamVzdC9mYWtlLXRpbWVycycpO1xuXG4gIF9mYWtlVGltZXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfamVzdE1vY2soKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKCdqZXN0LW1vY2snKTtcblxuICBfamVzdE1vY2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9qZXN0VXRpbCgpIHtcbiAgY29uc3QgZGF0YSA9IHJlcXVpcmUoJ2plc3QtdXRpbCcpO1xuXG4gIF9qZXN0VXRpbCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KG9iaiwga2V5LCB2YWx1ZSkge1xuICBpZiAoa2V5IGluIG9iaikge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwge1xuICAgICAgdmFsdWU6IHZhbHVlLFxuICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgIHdyaXRhYmxlOiB0cnVlXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgb2JqW2tleV0gPSB2YWx1ZTtcbiAgfVxuICByZXR1cm4gb2JqO1xufVxuXG5jbGFzcyBOb2RlRW52aXJvbm1lbnQge1xuICBjb25zdHJ1Y3Rvcihjb25maWcpIHtcbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgJ2NvbnRleHQnLCB2b2lkIDApO1xuXG4gICAgX2RlZmluZVByb3BlcnR5KHRoaXMsICdmYWtlVGltZXJzJywgdm9pZCAwKTtcblxuICAgIF9kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZmFrZVRpbWVyc01vZGVybicsIHZvaWQgMCk7XG5cbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgJ2dsb2JhbCcsIHZvaWQgMCk7XG5cbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgJ21vZHVsZU1vY2tlcicsIHZvaWQgMCk7XG5cbiAgICB0aGlzLmNvbnRleHQgPSAoMCwgX3ZtKCkuY3JlYXRlQ29udGV4dCkoKTtcbiAgICBjb25zdCBnbG9iYWwgPSAodGhpcy5nbG9iYWwgPSAoMCwgX3ZtKCkucnVuSW5Db250ZXh0KShcbiAgICAgICd0aGlzJyxcbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5jb250ZXh0LCBjb25maWcudGVzdEVudmlyb25tZW50T3B0aW9ucylcbiAgICApKTtcbiAgICBnbG9iYWwuZ2xvYmFsID0gZ2xvYmFsO1xuICAgIGdsb2JhbC5jbGVhckludGVydmFsID0gY2xlYXJJbnRlcnZhbDtcbiAgICBnbG9iYWwuY2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0O1xuICAgIGdsb2JhbC5zZXRJbnRlcnZhbCA9IHNldEludGVydmFsO1xuICAgIGdsb2JhbC5zZXRUaW1lb3V0ID0gc2V0VGltZW91dDtcbiAgICBnbG9iYWwuQnVmZmVyID0gQnVmZmVyO1xuICAgIGdsb2JhbC5zZXRJbW1lZGlhdGUgPSBzZXRJbW1lZGlhdGU7XG4gICAgZ2xvYmFsLmNsZWFySW1tZWRpYXRlID0gY2xlYXJJbW1lZGlhdGU7XG4gICAgZ2xvYmFsLkFycmF5QnVmZmVyID0gQXJyYXlCdWZmZXI7IC8vIFRleHRFbmNvZGVyIChnbG9iYWwgb3IgdmlhICd1dGlsJykgcmVmZXJlbmNlcyBhIFVpbnQ4QXJyYXkgY29uc3RydWN0b3JcbiAgICAvLyBkaWZmZXJlbnQgdGhhbiB0aGUgZ2xvYmFsIG9uZSB1c2VkIGJ5IHVzZXJzIGluIHRlc3RzLiBUaGlzIG1ha2VzIHN1cmUgdGhlXG4gICAgLy8gc2FtZSBjb25zdHJ1Y3RvciBpcyByZWZlcmVuY2VkIGJ5IGJvdGguXG5cbiAgICBnbG9iYWwuVWludDhBcnJheSA9IFVpbnQ4QXJyYXk7IC8vIFVSTCBhbmQgVVJMU2VhcmNoUGFyYW1zIGFyZSBnbG9iYWwgaW4gTm9kZSA+PSAxMFxuXG4gICAgaWYgKHR5cGVvZiBVUkwgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBVUkxTZWFyY2hQYXJhbXMgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBnbG9iYWwuVVJMID0gVVJMO1xuICAgICAgZ2xvYmFsLlVSTFNlYXJjaFBhcmFtcyA9IFVSTFNlYXJjaFBhcmFtcztcbiAgICB9IC8vIFRleHREZWNvZGVyIGFuZCBUZXh0RGVjb2RlciBhcmUgZ2xvYmFsIGluIE5vZGUgPj0gMTFcblxuICAgIGlmIChcbiAgICAgIHR5cGVvZiBUZXh0RW5jb2RlciAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAgIHR5cGVvZiBUZXh0RGVjb2RlciAhPT0gJ3VuZGVmaW5lZCdcbiAgICApIHtcbiAgICAgIGdsb2JhbC5UZXh0RW5jb2RlciA9IFRleHRFbmNvZGVyO1xuICAgICAgZ2xvYmFsLlRleHREZWNvZGVyID0gVGV4dERlY29kZXI7XG4gICAgfSAvLyBxdWV1ZU1pY3JvdGFzayBpcyBnbG9iYWwgaW4gTm9kZSA+PSAxMVxuXG4gICAgaWYgKHR5cGVvZiBxdWV1ZU1pY3JvdGFzayAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGdsb2JhbC5xdWV1ZU1pY3JvdGFzayA9IHF1ZXVlTWljcm90YXNrO1xuICAgIH0gLy8gQWJvcnRDb250cm9sbGVyIGlzIGdsb2JhbCBpbiBOb2RlID49IDE1XG5cbiAgICBpZiAodHlwZW9mIEFib3J0Q29udHJvbGxlciAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGdsb2JhbC5BYm9ydENvbnRyb2xsZXIgPSBBYm9ydENvbnRyb2xsZXI7XG4gICAgfSAvLyBBYm9ydFNpZ25hbCBpcyBnbG9iYWwgaW4gTm9kZSA+PSAxNVxuXG4gICAgaWYgKHR5cGVvZiBBYm9ydFNpZ25hbCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGdsb2JhbC5BYm9ydFNpZ25hbCA9IEFib3J0U2lnbmFsO1xuICAgIH0gLy8gRXZlbnQgaXMgZ2xvYmFsIGluIE5vZGUgPj0gMTUuNFxuXG4gICAgaWYgKHR5cGVvZiBFdmVudCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGdsb2JhbC5FdmVudCA9IEV2ZW50O1xuICAgIH0gLy8gRXZlbnRUYXJnZXQgaXMgZ2xvYmFsIGluIE5vZGUgPj0gMTUuNFxuXG4gICAgaWYgKHR5cGVvZiBFdmVudFRhcmdldCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGdsb2JhbC5FdmVudFRhcmdldCA9IEV2ZW50VGFyZ2V0O1xuICAgIH0gLy8gcGVyZm9ybWFuY2UgaXMgZ2xvYmFsIGluIE5vZGUgPj0gMTZcblxuICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBnbG9iYWwucGVyZm9ybWFuY2UgPSBwZXJmb3JtYW5jZTtcbiAgICB9XG5cbiAgICAoMCwgX2plc3RVdGlsKCkuaW5zdGFsbENvbW1vbkdsb2JhbHMpKGdsb2JhbCwgY29uZmlnLmdsb2JhbHMpO1xuICAgIHRoaXMubW9kdWxlTW9ja2VyID0gbmV3IChfamVzdE1vY2soKS5Nb2R1bGVNb2NrZXIpKGdsb2JhbCk7XG5cbiAgICBjb25zdCB0aW1lcklkVG9SZWYgPSBpZCA9PiAoe1xuICAgICAgaWQsXG5cbiAgICAgIHJlZigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9LFxuXG4gICAgICB1bnJlZigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB0aW1lclJlZlRvSWQgPSB0aW1lciA9PiAodGltZXIgJiYgdGltZXIuaWQpIHx8IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IHRpbWVyQ29uZmlnID0ge1xuICAgICAgaWRUb1JlZjogdGltZXJJZFRvUmVmLFxuICAgICAgcmVmVG9JZDogdGltZXJSZWZUb0lkXG4gICAgfTtcbiAgICB0aGlzLmZha2VUaW1lcnMgPSBuZXcgKF9mYWtlVGltZXJzKCkuTGVnYWN5RmFrZVRpbWVycykoe1xuICAgICAgY29uZmlnLFxuICAgICAgZ2xvYmFsLFxuICAgICAgbW9kdWxlTW9ja2VyOiB0aGlzLm1vZHVsZU1vY2tlcixcbiAgICAgIHRpbWVyQ29uZmlnXG4gICAgfSk7XG4gICAgdGhpcy5mYWtlVGltZXJzTW9kZXJuID0gbmV3IChfZmFrZVRpbWVycygpLk1vZGVybkZha2VUaW1lcnMpKHtcbiAgICAgIGNvbmZpZyxcbiAgICAgIGdsb2JhbFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2V0dXAoKSB7fVxuXG4gIGFzeW5jIHRlYXJkb3duKCkge1xuICAgIGlmICh0aGlzLmZha2VUaW1lcnMpIHtcbiAgICAgIHRoaXMuZmFrZVRpbWVycy5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZmFrZVRpbWVyc01vZGVybikge1xuICAgICAgdGhpcy5mYWtlVGltZXJzTW9kZXJuLmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbnRleHQgPSBudWxsO1xuICAgIHRoaXMuZmFrZVRpbWVycyA9IG51bGw7XG4gICAgdGhpcy5mYWtlVGltZXJzTW9kZXJuID0gbnVsbDtcbiAgfVxuXG4gIGdldFZtQ29udGV4dCgpIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0O1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTm9kZUVudmlyb25tZW50O1xuIl19
6a8321d45f8cec0dfe9543a684efe98c
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = useOnAction;

var React = _interopRequireWildcard(require("react"));

var _NavigationBuilderContext = _interopRequireDefault(require("./NavigationBuilderContext"));

var _useOnPreventRemove = _interopRequireWildcard(require("./useOnPreventRemove"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

function useOnAction(_ref) {
  var router = _ref.router,
      getState = _ref.getState,
      setState = _ref.setState,
      key = _ref.key,
      actionListeners = _ref.actionListeners,
      beforeRemoveListeners = _ref.beforeRemoveListeners,
      routerConfigOptions = _ref.routerConfigOptions,
      emitter = _ref.emitter;

  var _React$useContext = React.useContext(_NavigationBuilderContext.default),
      onActionParent = _React$useContext.onAction,
      onRouteFocusParent = _React$useContext.onRouteFocus,
      addListenerParent = _React$useContext.addListener,
      onDispatchAction = _React$useContext.onDispatchAction;

  var routerConfigOptionsRef = React.useRef(routerConfigOptions);
  React.useEffect(function () {
    routerConfigOptionsRef.current = routerConfigOptions;
  });
  var onAction = React.useCallback(function (action) {
    var visitedNavigators = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : new Set();
    var state = getState();

    if (visitedNavigators.has(state.key)) {
      return false;
    }

    visitedNavigators.add(state.key);

    if (typeof action.target !== 'string' || action.target === state.key) {
      var result = router.getStateForAction(state, action, routerConfigOptionsRef.current);
      result = result === null && action.target === state.key ? state : result;

      if (result !== null) {
        onDispatchAction(action, state === result);

        if (state !== result) {
          var isPrevented = (0, _useOnPreventRemove.shouldPreventRemove)(emitter, beforeRemoveListeners, state.routes, result.routes, action);

          if (isPrevented) {
            return true;
          }

          setState(result);
        }

        if (onRouteFocusParent !== undefined) {
          var shouldFocus = router.shouldActionChangeFocus(action);

          if (shouldFocus && key !== undefined) {
            onRouteFocusParent(key);
          }
        }

        return true;
      }
    }

    if (onActionParent !== undefined) {
      if (onActionParent(action, visitedNavigators)) {
        return true;
      }
    }

    for (var i = actionListeners.length - 1; i >= 0; i--) {
      var listener = actionListeners[i];

      if (listener(action, visitedNavigators)) {
        return true;
      }
    }

    return false;
  }, [actionListeners, beforeRemoveListeners, emitter, getState, key, onActionParent, onDispatchAction, onRouteFocusParent, router, setState]);
  (0, _useOnPreventRemove.default)({
    getState: getState,
    emitter: emitter,
    beforeRemoveListeners: beforeRemoveListeners
  });
  React.useEffect(function () {
    return addListenerParent === null || addListenerParent === void 0 ? void 0 : addListenerParent('action', onAction);
  }, [addListenerParent, onAction]);
  return onAction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVzZU9uQWN0aW9uLnRzeCJdLCJuYW1lcyI6WyJlbWl0dGVyIiwib25BY3Rpb24iLCJvblJvdXRlRm9jdXMiLCJhZGRMaXN0ZW5lciIsIm9uRGlzcGF0Y2hBY3Rpb24iLCJSZWFjdCIsIk5hdmlnYXRpb25CdWlsZGVyQ29udGV4dCIsInJvdXRlckNvbmZpZ09wdGlvbnNSZWYiLCJ2aXNpdGVkTmF2aWdhdG9ycyIsInN0YXRlIiwiZ2V0U3RhdGUiLCJhY3Rpb24iLCJyZXN1bHQiLCJyb3V0ZXIiLCJpc1ByZXZlbnRlZCIsInNldFN0YXRlIiwib25Sb3V0ZUZvY3VzUGFyZW50Iiwic2hvdWxkRm9jdXMiLCJrZXkiLCJvbkFjdGlvblBhcmVudCIsImkiLCJhY3Rpb25MaXN0ZW5lcnMiLCJsaXN0ZW5lciIsImJlZm9yZVJlbW92ZUxpc3RlbmVycyIsImFkZExpc3RlbmVyUGFyZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsSUFBQSxLQUFBLEdBQUEsdUJBQUEsQ0FBQSxPQUFBLENBQUEsT0FBQSxDQUFBLENBQUE7O0FBUUEsSUFBQSx5QkFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLDRCQUFBLENBQUEsQ0FBQTs7QUFJQSxJQUFBLG1CQUFBLEdBQUEsdUJBQUEsQ0FBQSxPQUFBLENBQUEsc0JBQUEsQ0FBQSxDQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF3QmUsU0FBQSxXQUFBLE9BU0g7QUFBQSxNQVR3QixNQVN4QixRQVR3QixNQVN4QjtBQUFBLE1BVHdCLFFBU3hCLFFBVHdCLFFBU3hCO0FBQUEsTUFUd0IsUUFTeEIsUUFUd0IsUUFTeEI7QUFBQSxNQVR3QixHQVN4QixRQVR3QixHQVN4QjtBQUFBLE1BVHdCLGVBU3hCLFFBVHdCLGVBU3hCO0FBQUEsTUFUd0IscUJBU3hCLFFBVHdCLHFCQVN4QjtBQUFBLE1BVHdCLG1CQVN4QixRQVR3QixtQkFTeEI7QUFBQSxNQURWQSxP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QUN2QyxlQUFBLElBQUE7QUFDRDtBQUNGOztBQUVELFdBQUEsS0FBQTtBQTVFYSxHQUFBLEVBOEVmLENBQUEsZUFBQSxFQUFBLHFCQUFBLEVBQUEsT0FBQSxFQUFBLFFBQUEsRUFBQSxHQUFBLEVBQUEsY0FBQSxFQUFBLGdCQUFBLEVBQUEsa0JBQUEsRUFBQSxNQUFBLEVBOUVGLFFBOEVFLENBOUVlLENBQWpCO0FBNEZBLEdBQUEsR0FBQSxtQkFBQSxDQUFBLE9BQUEsRUFBbUI7QUFDakJaLElBQUFBLFFBRGlCLEVBQ2pCQSxRQURpQjtBQUVqQlYsSUFBQUEsT0FGaUIsRUFFakJBLE9BRmlCO0FBR2pCdUIsSUFBQUEscUJBQUFBLEVBQUFBO0FBSGlCLEdBQW5CO0FBTUFsQixFQUFBQSxLQUFLLENBQUxBLFNBQUFBLENBQWdCO0FBQUEsV0FBTW1CLGlCQUFOLEtBQUEsSUFBTUEsSUFBQUEsaUJBQU4sS0FBQSxLQUFBLENBQU1BLEdBQU4sS0FBQSxDQUFNQSxHQUFBQSxpQkFBaUIsQ0FBQSxRQUFBLEVBQXZDbkIsUUFBdUMsQ0FBdkI7QUFBQSxHQUFoQkEsRUFBK0QsQ0FBQSxpQkFBQSxFQUEvREEsUUFBK0QsQ0FBL0RBO0FBS0EsU0FBQSxRQUFBO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgdHlwZSB7XG4gIE5hdmlnYXRpb25BY3Rpb24sXG4gIE5hdmlnYXRpb25TdGF0ZSxcbiAgUGFydGlhbFN0YXRlLFxuICBSb3V0ZXIsXG4gIFJvdXRlckNvbmZpZ09wdGlvbnMsXG59IGZyb20gJ0ByZWFjdC1uYXZpZ2F0aW9uL3JvdXRlcnMnO1xuaW1wb3J0IE5hdmlnYXRpb25CdWlsZGVyQ29udGV4dCwge1xuICBDaGlsZEFjdGlvbkxpc3RlbmVyLFxuICBDaGlsZEJlZm9yZVJlbW92ZUxpc3RlbmVyLFxufSBmcm9tICcuL05hdmlnYXRpb25CdWlsZGVyQ29udGV4dCc7XG5pbXBvcnQgdXNlT25QcmV2ZW50UmVtb3ZlLCB7IHNob3VsZFByZXZlbnRSZW1vdmUgfSBmcm9tICcuL3VzZU9uUHJldmVudFJlbW92ZSc7XG5pbXBvcnQgdHlwZSB7IE5hdmlnYXRpb25FdmVudEVtaXR0ZXIgfSBmcm9tICcuL3VzZUV2ZW50RW1pdHRlcic7XG5pbXBvcnQgdHlwZSB7IEV2ZW50TWFwQ29yZSB9IGZyb20gJy4vdHlwZXMnO1xuXG50eXBlIE9wdGlvbnMgPSB7XG4gIHJvdXRlcjogUm91dGVyPE5hdmlnYXRpb25TdGF0ZSwgTmF2aWdhdGlvbkFjdGlvbj47XG4gIGtleT86IHN0cmluZztcbiAgZ2V0U3RhdGU6ICgpID0+IE5hdmlnYXRpb25TdGF0ZTtcbiAgc2V0U3RhdGU6IChzdGF0ZTogTmF2aWdhdGlvblN0YXRlIHwgUGFydGlhbFN0YXRlPE5hdmlnYXRpb25TdGF0ZT4pID0+IHZvaWQ7XG4gIGFjdGlvbkxpc3RlbmVyczogQ2hpbGRBY3Rpb25MaXN0ZW5lcltdO1xuICBiZWZvcmVSZW1vdmVMaXN0ZW5lcnM6IFJlY29yZDxzdHJpbmcsIENoaWxkQmVmb3JlUmVtb3ZlTGlzdGVuZXIgfCB1bmRlZmluZWQ+O1xuICByb3V0ZXJDb25maWdPcHRpb25zOiBSb3V0ZXJDb25maWdPcHRpb25zO1xuICBlbWl0dGVyOiBOYXZpZ2F0aW9uRXZlbnRFbWl0dGVyPEV2ZW50TWFwQ29yZTxhbnk+Pjtcbn07XG5cbi8qKlxuICogSG9vayB0byBoYW5kbGUgYWN0aW9ucyBmb3IgYSBuYXZpZ2F0b3IsIGluY2x1ZGluZyBzdGF0ZSB1cGRhdGVzIGFuZCBidWJibGluZy5cbiAqXG4gKiBCdWJibGluZyBhbiBhY3Rpb24gaXMgYWNoaWV2ZWQgaW4gMiB3YXlzOlxuICogMS4gVG8gYnViYmxlIGFjdGlvbiB0byBwYXJlbnQsIHdlIGV4cG9zZSB0aGUgYWN0aW9uIGhhbmRsZXIgaW4gY29udGV4dCBhbmQgdGhlbiBhY2Nlc3MgdGhlIHBhcmVudCBjb250ZXh0XG4gKiAyLiBUbyBidWJibGUgYWN0aW9uIHRvIGNoaWxkLCBjaGlsZCBhZGRzIGV2ZW50IGxpc3RlbmVycyBzdWJzY3JpYmluZyB0byBhY3Rpb25zIGZyb20gcGFyZW50XG4gKlxuICogV2hlbiB0aGUgYWN0aW9uIGhhbmRsZXIgaGFuZGxlcyBhcyBhY3Rpb24sIGl0IHJldHVybnMgYHRydWVgLCBvdGhlcndpc2UgYGZhbHNlYC5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdXNlT25BY3Rpb24oe1xuICByb3V0ZXIsXG4gIGdldFN0YXRlLFxuICBzZXRTdGF0ZSxcbiAga2V5LFxuICBhY3Rpb25MaXN0ZW5lcnMsXG4gIGJlZm9yZVJlbW92ZUxpc3RlbmVycyxcbiAgcm91dGVyQ29uZmlnT3B0aW9ucyxcbiAgZW1pdHRlcixcbn06IE9wdGlvbnMpIHtcbiAgY29uc3Qge1xuICAgIG9uQWN0aW9uOiBvbkFjdGlvblBhcmVudCxcbiAgICBvblJvdXRlRm9jdXM6IG9uUm91dGVGb2N1c1BhcmVudCxcbiAgICBhZGRMaXN0ZW5lcjogYWRkTGlzdGVuZXJQYXJlbnQsXG4gICAgb25EaXNwYXRjaEFjdGlvbixcbiAgfSA9IFJlYWN0LnVzZUNvbnRleHQoTmF2aWdhdGlvbkJ1aWxkZXJDb250ZXh0KTtcblxuICBjb25zdCByb3V0ZXJDb25maWdPcHRpb25zUmVmID0gUmVhY3QudXNlUmVmPFJvdXRlckNvbmZpZ09wdGlvbnM+KFxuICAgIHJvdXRlckNvbmZpZ09wdGlvbnNcbiAgKTtcblxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIHJvdXRlckNvbmZpZ09wdGlvbnNSZWYuY3VycmVudCA9IHJvdXRlckNvbmZpZ09wdGlvbnM7XG4gIH0pO1xuXG4gIGNvbnN0IG9uQWN0aW9uID0gUmVhY3QudXNlQ2FsbGJhY2soXG4gICAgKFxuICAgICAgYWN0aW9uOiBOYXZpZ2F0aW9uQWN0aW9uLFxuICAgICAgdmlzaXRlZE5hdmlnYXRvcnM6IFNldDxzdHJpbmc+ID0gbmV3IFNldDxzdHJpbmc+KClcbiAgICApID0+IHtcbiAgICAgIGNvbnN0IHN0YXRlID0gZ2V0U3RhdGUoKTtcblxuICAgICAgLy8gU2luY2UgYWN0aW9ucyBjYW4gYnViYmxlIGJvdGggdXAgYW5kIGRvd24sIHRoZXkgY291bGQgY29tZSB0byB0aGUgc2FtZSBuYXZpZ2F0b3IgYWdhaW5cbiAgICAgIC8vIFdlIGtlZXAgdHJhY2sgb2YgbmF2aWdhdG9ycyB3aGljaCBoYXZlIGFscmVhZHkgdHJpZWQgdG8gaGFuZGxlIHRoZSBhY3Rpb24gYW5kIHJldHVybiBpZiBpdCdzIGFscmVhZHkgdmlzaXRlZFxuICAgICAgaWYgKHZpc2l0ZWROYXZpZ2F0b3JzLmhhcyhzdGF0ZS5rZXkpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgdmlzaXRlZE5hdmlnYXRvcnMuYWRkKHN0YXRlLmtleSk7XG5cbiAgICAgIGlmICh0eXBlb2YgYWN0aW9uLnRhcmdldCAhPT0gJ3N0cmluZycgfHwgYWN0aW9uLnRhcmdldCA9PT0gc3RhdGUua2V5KSB7XG4gICAgICAgIGxldCByZXN1bHQgPSByb3V0ZXIuZ2V0U3RhdGVGb3JBY3Rpb24oXG4gICAgICAgICAgc3RhdGUsXG4gICAgICAgICAgYWN0aW9uLFxuICAgICAgICAgIHJvdXRlckNvbmZpZ09wdGlvbnNSZWYuY3VycmVudFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIElmIGEgdGFyZ2V0IGlzIHNwZWNpZmllZCBhbmQgc2V0IHRvIGN1cnJlbnQgbmF2aWdhdG9yLCB0aGUgYWN0aW9uIHNob3VsZG4ndCBidWJibGVcbiAgICAgICAgLy8gU28gaW5zdGVhZCBvZiBgbnVsbGAsIHdlIHVzZSB0aGUgc3RhdGUgb2JqZWN0IGZvciBzdWNoIGNhc2VzIHRvIHNpZ25hbCB0aGF0IGFjdGlvbiB3YXMgaGFuZGxlZFxuICAgICAgICByZXN1bHQgPVxuICAgICAgICAgIHJlc3VsdCA9PT0gbnVsbCAmJiBhY3Rpb24udGFyZ2V0ID09PSBzdGF0ZS5rZXkgPyBzdGF0ZSA6IHJlc3VsdDtcblxuICAgICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7XG4gICAgICAgICAgb25EaXNwYXRjaEFjdGlvbihhY3Rpb24sIHN0YXRlID09PSByZXN1bHQpO1xuXG4gICAgICAgICAgaWYgKHN0YXRlICE9PSByZXN1bHQpIHtcbiAgICAgICAgICAgIGNvbnN0IGlzUHJldmVudGVkID0gc2hvdWxkUHJldmVudFJlbW92ZShcbiAgICAgICAgICAgICAgZW1pdHRlcixcbiAgICAgICAgICAgICAgYmVmb3JlUmVtb3ZlTGlzdGVuZXJzLFxuICAgICAgICAgICAgICBzdGF0ZS5yb3V0ZXMsXG4gICAgICAgICAgICAgIHJlc3VsdC5yb3V0ZXMsXG4gICAgICAgICAgICAgIGFjdGlvblxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKGlzUHJldmVudGVkKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXRTdGF0ZShyZXN1bHQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChvblJvdXRlRm9jdXNQYXJlbnQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8gU29tZSBhY3Rpb25zIHN1Y2ggYXMgYE5BVklHQVRFYCBhbHNvIHdhbnQgdG8gYnJpbmcgdGhlIG5hdmlnYXRlZCByb3V0ZSB0byBmb2N1cyBpbiB0aGUgd2hvbGUgdHJlZVxuICAgICAgICAgICAgLy8gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIGZvY3VzIGFsbCBvZiB0aGUgcGFyZW50IG5hdmlnYXRvcnMgb2YgdGhpcyBuYXZpZ2F0b3IgYXMgd2VsbFxuICAgICAgICAgICAgY29uc3Qgc2hvdWxkRm9jdXMgPSByb3V0ZXIuc2hvdWxkQWN0aW9uQ2hhbmdlRm9jdXMoYWN0aW9uKTtcblxuICAgICAgICAgICAgaWYgKHNob3VsZEZvY3VzICYmIGtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIG9uUm91dGVGb2N1c1BhcmVudChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChvbkFjdGlvblBhcmVudCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIEJ1YmJsZSBhY3Rpb24gdG8gdGhlIHBhcmVudCBpZiB0aGUgY3VycmVudCBuYXZpZ2F0b3IgZGlkbid0IGhhbmRsZSBpdFxuICAgICAgICBpZiAob25BY3Rpb25QYXJlbnQoYWN0aW9uLCB2aXNpdGVkTmF2aWdhdG9ycykpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBJZiB0aGUgYWN0aW9uIHdhc24ndCBoYW5kbGVkIGJ5IGN1cnJlbnQgbmF2aWdhdG9yIG9yIGEgcGFyZW50IG5hdmlnYXRvciwgbGV0IGNoaWxkcmVuIGhhbmRsZSBpdFxuICAgICAgZm9yIChsZXQgaSA9IGFjdGlvbkxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBjb25zdCBsaXN0ZW5lciA9IGFjdGlvbkxpc3RlbmVyc1tpXTtcblxuICAgICAgICBpZiAobGlzdGVuZXIoYWN0aW9uLCB2aXNpdGVkTmF2aWdhdG9ycykpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSxcbiAgICBbXG4gICAgICBhY3Rpb25MaXN0ZW5lcnMsXG4gICAgICBiZWZvcmVSZW1vdmVMaXN0ZW5lcnMsXG4gICAgICBlbWl0dGVyLFxuICAgICAgZ2V0U3RhdGUsXG4gICAgICBrZXksXG4gICAgICBvbkFjdGlvblBhcmVudCxcbiAgICAgIG9uRGlzcGF0Y2hBY3Rpb24sXG4gICAgICBvblJvdXRlRm9jdXNQYXJlbnQsXG4gICAgICByb3V0ZXIsXG4gICAgICBzZXRTdGF0ZSxcbiAgICBdXG4gICk7XG5cbiAgdXNlT25QcmV2ZW50UmVtb3ZlKHtcbiAgICBnZXRTdGF0ZSxcbiAgICBlbWl0dGVyLFxuICAgIGJlZm9yZVJlbW92ZUxpc3RlbmVycyxcbiAgfSk7XG5cbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IGFkZExpc3RlbmVyUGFyZW50Py4oJ2FjdGlvbicsIG9uQWN0aW9uKSwgW1xuICAgIGFkZExpc3RlbmVyUGFyZW50LFxuICAgIG9uQWN0aW9uLFxuICBdKTtcblxuICByZXR1cm4gb25BY3Rpb247XG59XG4iXX0=
303a13b5c569a58c2111ed418beb28fa
"use strict";

var __extends = this && this.__extends || function () {
  var _extendStatics = function extendStatics(d, b) {
    _extendStatics = Object.setPrototypeOf || {
      __proto__: []
    } instanceof Array && function (d, b) {
      d.__proto__ = b;
    } || function (d, b) {
      for (var p in b) {
        if (b.hasOwnProperty(p)) d[p] = b[p];
      }
    };

    return _extendStatics(d, b);
  };

  return function (d, b) {
    _extendStatics(d, b);

    function __() {
      this.constructor = d;
    }

    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();

Object.defineProperty(exports, "__esModule", {
  value: true
});

var innerSubscribe_1 = require("../innerSubscribe");

function expand(project, concurrent, scheduler) {
  if (concurrent === void 0) {
    concurrent = Number.POSITIVE_INFINITY;
  }

  concurrent = (concurrent || 0) < 1 ? Number.POSITIVE_INFINITY : concurrent;
  return function (source) {
    return source.lift(new ExpandOperator(project, concurrent, scheduler));
  };
}

exports.expand = expand;

var ExpandOperator = function () {
  function ExpandOperator(project, concurrent, scheduler) {
    this.project = project;
    this.concurrent = concurrent;
    this.scheduler = scheduler;
  }

  ExpandOperator.prototype.call = function (subscriber, source) {
    return source.subscribe(new ExpandSubscriber(subscriber, this.project, this.concurrent, this.scheduler));
  };

  return ExpandOperator;
}();

exports.ExpandOperator = ExpandOperator;

var ExpandSubscriber = function (_super) {
  __extends(ExpandSubscriber, _super);

  function ExpandSubscriber(destination, project, concurrent, scheduler) {
    var _this = _super.call(this, destination) || this;

    _this.project = project;
    _this.concurrent = concurrent;
    _this.scheduler = scheduler;
    _this.index = 0;
    _this.active = 0;
    _this.hasCompleted = false;

    if (concurrent < Number.POSITIVE_INFINITY) {
      _this.buffer = [];
    }

    return _this;
  }

  ExpandSubscriber.dispatch = function (arg) {
    var subscriber = arg.subscriber,
        result = arg.result,
        value = arg.value,
        index = arg.index;
    subscriber.subscribeToProjection(result, value, index);
  };

  ExpandSubscriber.prototype._next = function (value) {
    var destination = this.destination;

    if (destination.closed) {
      this._complete();

      return;
    }

    var index = this.index++;

    if (this.active < this.concurrent) {
      destination.next(value);

      try {
        var project = this.project;
        var result = project(value, index);

        if (!this.scheduler) {
          this.subscribeToProjection(result, value, index);
        } else {
          var state = {
            subscriber: this,
            result: result,
            value: value,
            index: index
          };
          var destination_1 = this.destination;
          destination_1.add(this.scheduler.schedule(ExpandSubscriber.dispatch, 0, state));
        }
      } catch (e) {
        destination.error(e);
      }
    } else {
      this.buffer.push(value);
    }
  };

  ExpandSubscriber.prototype.subscribeToProjection = function (result, value, index) {
    this.active++;
    var destination = this.destination;
    destination.add(innerSubscribe_1.innerSubscribe(result, new innerSubscribe_1.SimpleInnerSubscriber(this)));
  };

  ExpandSubscriber.prototype._complete = function () {
    this.hasCompleted = true;

    if (this.hasCompleted && this.active === 0) {
      this.destination.complete();
    }

    this.unsubscribe();
  };

  ExpandSubscriber.prototype.notifyNext = function (innerValue) {
    this._next(innerValue);
  };

  ExpandSubscriber.prototype.notifyComplete = function () {
    var buffer = this.buffer;
    this.active--;

    if (buffer && buffer.length > 0) {
      this._next(buffer.shift());
    }

    if (this.hasCompleted && this.active === 0) {
      this.destination.complete();
    }
  };

  return ExpandSubscriber;
}(innerSubscribe_1.SimpleOuterSubscriber);

exports.ExpandSubscriber = ExpandSubscriber;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlcm5hbC9vcGVyYXRvcnMvZXhwYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBS0EsSUFBQSxnQkFBQSxHQUFBLE9BQUEsQ0FBQSxtQkFBQSxDQUFBOztBQTJEQSxTQUFnQixNQUFoQixDQUE2QixPQUE3QixFQUM2QixVQUQ3QixFQUU2QixTQUY3QixFQUVzRDtBQUR6QixNQUFBLFVBQUEsS0FBQSxLQUFBLENBQUEsRUFBQTtBQUFBLElBQUEsVUFBQSxHQUFxQixNQUFNLENBQUMsaUJBQTVCO0FBQTZDOztBQUV4RSxFQUFBLFVBQVUsR0FBRyxDQUFDLFVBQVUsSUFBSSxDQUFmLElBQW9CLENBQXBCLEdBQXdCLE1BQU0sQ0FBQyxpQkFBL0IsR0FBbUQsVUFBaEU7QUFFQSxTQUFPLFVBQUMsTUFBRCxFQUFzQjtBQUFLLFdBQUEsTUFBTSxDQUFDLElBQVAsQ0FBWSxJQUFJLGNBQUosQ0FBbUIsT0FBbkIsRUFBNEIsVUFBNUIsRUFBWixTQUFZLENBQVosQ0FBQTtBQUErRCxHQUFqRztBQUNEOztBQU5ELE9BQUEsQ0FBQSxNQUFBLEdBQUEsTUFBQTs7QUFRQSxJQUFBLGNBQUEsR0FBQSxZQUFBO0FBQ0UsV0FBQSxjQUFBLENBQW9CLE9BQXBCLEVBQ29CLFVBRHBCLEVBRW9CLFNBRnBCLEVBRTZDO0FBRnpCLFNBQUEsT0FBQSxHQUFBLE9BQUE7QUFDQSxTQUFBLFVBQUEsR0FBQSxVQUFBO0FBQ0EsU0FBQSxTQUFBLEdBQUEsU0FBQTtBQUNuQjs7QUFFRCxFQUFBLGNBQUEsQ0FBQSxTQUFBLENBQUEsSUFBQSxHQUFBLFVBQUssVUFBTCxFQUFnQyxNQUFoQyxFQUEyQztBQUN6QyxXQUFPLE1BQU0sQ0FBQyxTQUFQLENBQWlCLElBQUksZ0JBQUosQ0FBcUIsVUFBckIsRUFBaUMsS0FBSyxPQUF0QyxFQUErQyxLQUFLLFVBQXBELEVBQWdFLEtBQUssU0FBckUsQ0FBakIsQ0FB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
717d2464c64d2f36f816171c2ebb15ce
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault2(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/slicedToArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getPathFromState;

var queryString = _interopRequireWildcard(require("query-string"));

var _checkLegacyPathConfig = _interopRequireDefault(require("./checkLegacyPathConfig"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var getActiveRoute = function getActiveRoute(state) {
  var route = typeof state.index === 'number' ? state.routes[state.index] : state.routes[state.routes.length - 1];

  if (route.state) {
    return getActiveRoute(route.state);
  }

  return route;
};

function getPathFromState(state, options) {
  if (state == null) {
    throw Error("Got 'undefined' for the navigation state. You must pass a valid state object.");
  }

  var _ref = (0, _checkLegacyPathConfig.default)(options),
      _ref2 = (0, _slicedToArray2.default)(_ref, 2),
      legacy = _ref2[0],
      compatOptions = _ref2[1];

  var configs = compatOptions ? createNormalizedConfigs(legacy, compatOptions.screens) : {};
  var path = '/';
  var current = state;
  var allParams = {};

  var _loop = function _loop() {
    var index = typeof current.index === 'number' ? current.index : 0;
    var route = current.routes[index];
    var pattern = void 0;
    var focusedParams = void 0;
    var focusedRoute = getActiveRoute(state);
    var currentOptions = configs;
    var nestedRouteNames = [];
    var hasNext = true;

    while (route.name in currentOptions && hasNext) {
      pattern = currentOptions[route.name].pattern;
      nestedRouteNames.push(route.name);

      if (route.params) {
        (function () {
          var stringify = (_currentOptions$route = currentOptions[route.name]) === null || _currentOptions$route === void 0 ? void 0 : _currentOptions$route.stringify;
          var currentParams = fromEntries(Object.entries(route.params).map(function (_ref3) {
            var _ref4 = (0, _slicedToArray2.default)(_ref3, 2),
                key = _ref4[0],
                value = _ref4[1];

            return [key, stringify !== null && stringify !== void 0 && stringify[key] ? stringify[key](value) : String(value)];
          }));

          if (pattern) {
            (0, _extends2.default)(allParams, currentParams);
          }

          if (focusedRoute === route) {
            focusedParams = (0, _extends2.default)({}, currentParams);
            (_pattern = pattern) === null || _pattern === void 0 ? void 0 : _pattern.split('/').filter(function (p) {
              return p.startsWith(':');
            }).forEach(function (p) {
              var name = getParamName(p);

              if (focusedParams) {
                delete focusedParams[name];
              }
            });
          }
        })();
      }

      if (!currentOptions[route.name].screens || route.state === undefined) {
        hasNext = false;
      } else {
        index = typeof route.state.index === 'number' ? route.state.index : route.state.routes.length - 1;
        var nextRoute = route.state.routes[index];
        var nestedConfig = currentOptions[route.name].screens;

        if (nestedConfig && nextRoute.name in nestedConfig) {
          route = nextRoute;
          currentOptions = nestedConfig;
        } else {
          hasNext = false;
        }
      }
    }

    if (pattern === undefined) {
      pattern = nestedRouteNames.join('/');
    }

    if (currentOptions[route.name] !== undefined) {
      path += pattern.split('/').map(function (p) {
        var name = getParamName(p);

        if (p === '*') {
          if (legacy) {
            throw new Error("Please update your config to the new format to use wildcard pattern ('*'). https://reactnavigation.org/docs/5.x/configuring-links/#updating-config");
          }

          return route.name;
        }

        if (p.startsWith(':')) {
          var value = allParams[name];

          if (value === undefined && p.endsWith('?')) {
            return '';
          }

          return encodeURIComponent(value);
        }

        return encodeURIComponent(p);
      }).join('/');
    } else {
      path += encodeURIComponent(route.name);
    }

    if (!focusedParams) {
      focusedParams = focusedRoute.params;
    }

    if (route.state) {
      path += '/';
    } else if (focusedParams) {
      for (var param in focusedParams) {
        if (focusedParams[param] === 'undefined') {
          delete focusedParams[param];
        }
      }

      var query = queryString.stringify(focusedParams);

      if (query) {
        path += "?".concat(query);
      }
    }

    current = route.state;
  };

  while (current) {
    var _currentOptions$route;

    var _pattern;

    _loop();
  }

  path = path.replace(/\/+/g, '/');
  path = path.length > 1 ? path.replace(/\/$/, '') : path;
  return path;
}

var fromEntries = function fromEntries(entries) {
  return entries.reduce(function (acc, _ref5) {
    var _ref6 = (0, _slicedToArray2.default)(_ref5, 2),
        k = _ref6[0],
        v = _ref6[1];

    if (acc.hasOwnProperty(k)) {
      throw new Error("A value for key '".concat(k, "' already exists in the object."));
    }

    acc[k] = v;
    return acc;
  }, {});
};

var getParamName = function getParamName(pattern) {
  return pattern.replace(/^:/, '').replace(/\?$/, '');
};

var joinPaths = function joinPaths() {
  var _ref7;

  for (var _len = arguments.length, paths = new Array(_len), _key = 0; _key < _len; _key++) {
    paths[_key] = arguments[_key];
  }

  return (_ref7 = []).concat.apply(_ref7, (0, _toConsumableArray2.default)(paths.map(function (p) {
    return p.split('/');
  }))).filter(Boolean).join('/');
};

var createConfigItem = function createConfigItem(legacy, config, parentPattern) {
  var _pattern2;

  if (typeof config === 'string') {
    var _pattern3 = parentPattern ? joinPaths(parentPattern, config) : config;

    return {
      pattern: _pattern3
    };
  }

  var pattern;

  if (legacy) {
    pattern = config.exact !== true && parentPattern && config.path ? joinPaths(parentPattern, config.path) : config.path;
  } else {
    if (config.exact && config.path === undefined) {
      throw new Error("A 'path' needs to be specified when specifying 'exact: true'. If you don't want this screen in the URL, specify it as empty string, e.g. `path: ''`.");
    }

    pattern = config.exact !== true ? joinPaths(parentPattern || '', config.path || '') : config.path || '';
  }

  var screens = config.screens ? createNormalizedConfigs(legacy, config.screens, pattern) : undefined;
  return {
    pattern: (_pattern2 = pattern) === null || _pattern2 === void 0 ? void 0 : _pattern2.split('/').filter(Boolean).join('/'),
    stringify: config.stringify,
    screens: screens
  };
};

var createNormalizedConfigs = function createNormalizedConfigs(legacy, options, pattern) {
  return fromEntries(Object.entries(options).map(function (_ref8) {
    var _ref9 = (0, _slicedToArray2.default)(_ref8, 2),
        name = _ref9[0],
        c = _ref9[1];

    var result = createConfigItem(legacy, c, pattern);
    return [name, result];
  }));
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldFBhdGhGcm9tU3RhdGUudHN4Il0sIm5hbWVzIjpbImdldEFjdGl2ZVJvdXRlIiwic3RhdGUiLCJyb3V0ZSIsIkVycm9yIiwiY29uZmlncyIsImNvbXBhdE9wdGlvbnMiLCJjcmVhdGVOb3JtYWxpemVkQ29uZmlncyIsInBhdGgiLCJjdXJyZW50IiwiYWxsUGFyYW1zIiwiaW5kZXgiLCJwYXR0ZXJuIiwiZm9jdXNlZFBhcmFtcyIsImZvY3VzZWRSb3V0ZSIsImN1cnJlbnRPcHRpb25zIiwibmVzdGVkUm91dGVOYW1lcyIsImhhc05leHQiLCJzdHJpbmdpZnkiLCJjdXJyZW50UGFyYW1zIiwiZnJvbUVudHJpZXMiLCJPYmplY3QiLCJTdHJpbmciLCJwIiwibmFtZSIsImdldFBhcmFtTmFtZSIsIm5leHRSb3V0ZSIsIm5lc3RlZENvbmZpZyIsInZhbHVlIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwicXVlcnkiLCJxdWVyeVN0cmluZyIsImVudHJpZXMiLCJhY2MiLCJqb2luUGF0aHMiLCJwYXRocyIsImNyZWF0ZUNvbmZpZ0l0ZW0iLCJwYXJlbnRQYXR0ZXJuIiwiY29uZmlnIiwic2NyZWVucyIsInJlc3VsdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBQSxXQUFBLEdBQUEsdUJBQUEsQ0FBQSxPQUFBLENBQUEsY0FBQSxDQUFBLENBQUE7O0FBTUEsSUFBQSxzQkFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLHlCQUFBLENBQUEsQ0FBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBZUEsSUFBTUEsY0FBYyxHQUFJQyxTQUFsQkQsY0FBa0JDLENBQUFBLEtBQUQsRUFBcUQ7QUFDMUUsTUFBTUMsS0FBSyxHQUNULE9BQU9ELEtBQUssQ0FBWixLQUFBLEtBQUEsUUFBQSxHQUNJQSxLQUFLLENBQUxBLE1BQUFBLENBQWFBLEtBQUssQ0FEdEIsS0FDSUEsQ0FESixHQUVJ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QUEsQ0FBQSxPQUFBLEVBQUEsR0FBQSxDQUE0QixpQkFBZTtBQUFBO0FBQUEsUUFBZCxJQUFjO0FBQUEsUUFBZixDQUFlOztBQUN6QyxRQUFNb0IsTUFBTSxHQUFHSixnQkFBZ0IsQ0FBQSxNQUFBLEVBQUEsQ0FBQSxFQUEvQixPQUErQixDQUEvQjtBQUVBLFdBQU8sQ0FBQSxJQUFBLEVBQVAsTUFBTyxDQUFQO0FBVE4sR0FNSSxDQURTLENBTG1CO0FBQUEsQ0FBaEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBxdWVyeVN0cmluZyBmcm9tICdxdWVyeS1zdHJpbmcnO1xuaW1wb3J0IHR5cGUge1xuICBOYXZpZ2F0aW9uU3RhdGUsXG4gIFBhcnRpYWxTdGF0ZSxcbiAgUm91dGUsXG59IGZyb20gJ0ByZWFjdC1uYXZpZ2F0aW9uL3JvdXRlcnMnO1xuaW1wb3J0IGNoZWNrTGVnYWN5UGF0aENvbmZpZyBmcm9tICcuL2NoZWNrTGVnYWN5UGF0aENvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFBhdGhDb25maWcsIFBhdGhDb25maWdNYXAgfSBmcm9tICcuL3R5cGVzJztcblxudHlwZSBPcHRpb25zID0geyBpbml0aWFsUm91dGVOYW1lPzogc3RyaW5nOyBzY3JlZW5zOiBQYXRoQ29uZmlnTWFwIH07XG5cbnR5cGUgU3RhdGUgPSBOYXZpZ2F0aW9uU3RhdGUgfCBPbWl0PFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+LCAnc3RhbGUnPjtcblxudHlwZSBTdHJpbmdpZnlDb25maWcgPSBSZWNvcmQ8c3RyaW5nLCAodmFsdWU6IGFueSkgPT4gc3RyaW5nPjtcblxudHlwZSBDb25maWdJdGVtID0ge1xuICBwYXR0ZXJuPzogc3RyaW5nO1xuICBzdHJpbmdpZnk/OiBTdHJpbmdpZnlDb25maWc7XG4gIHNjcmVlbnM/OiBSZWNvcmQ8c3RyaW5nLCBDb25maWdJdGVtPjtcbn07XG5cbmNvbnN0IGdldEFjdGl2ZVJvdXRlID0gKHN0YXRlOiBTdGF0ZSk6IHsgbmFtZTogc3RyaW5nOyBwYXJhbXM/OiBvYmplY3QgfSA9PiB7XG4gIGNvbnN0IHJvdXRlID1cbiAgICB0eXBlb2Ygc3RhdGUuaW5kZXggPT09ICdudW1iZXInXG4gICAgICA/IHN0YXRlLnJvdXRlc1tzdGF0ZS5pbmRleF1cbiAgICAgIDogc3RhdGUucm91dGVzW3N0YXRlLnJvdXRlcy5sZW5ndGggLSAxXTtcblxuICBpZiAocm91dGUuc3RhdGUpIHtcbiAgICByZXR1cm4gZ2V0QWN0aXZlUm91dGUocm91dGUuc3RhdGUpO1xuICB9XG5cbiAgcmV0dXJuIHJvdXRlO1xufTtcblxuLyoqXG4gKiBVdGlsaXR5IHRvIHNlcmlhbGl6ZSBhIG5hdmlnYXRpb24gc3RhdGUgb2JqZWN0IHRvIGEgcGF0aCBzdHJpbmcuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYGpzXG4gKiBnZXRQYXRoRnJvbVN0YXRlKFxuICogICB7XG4gKiAgICAgcm91dGVzOiBbXG4gKiAgICAgICB7XG4gKiAgICAgICAgIG5hbWU6ICdDaGF0JyxcbiAqICAgICAgICAgcGFyYW1zOiB7IGF1dGhvcjogJ0phbmUnLCBpZDogNDIgfSxcbiAqICAgICAgIH0sXG4gKiAgICAgXSxcbiAqICAgfSxcbiAqICAge1xuICogICAgIHNjcmVlbnM6IHtcbiAqICAgICAgIENoYXQ6IHtcbiAqICAgICAgICAgcGF0aDogJ2NoYXQvOmF1dGhvci86aWQnLFxuICogICAgICAgICBzdHJpbmdpZnk6IHsgYXV0aG9yOiBhdXRob3IgPT4gYXV0aG9yLnRvTG93ZXJDYXNlKCkgfVxuICogICAgICAgfVxuICogICAgIH1cbiAqICAgfVxuICogKVxuICogYGBgXG4gKlxuICogQHBhcmFtIHN0YXRlIE5hdmlnYXRpb24gc3RhdGUgdG8gc2VyaWFsaXplLlxuICogQHBhcmFtIG9wdGlvbnMgRXh0cmEgb3B0aW9ucyB0byBmaW5lLXR1bmUgaG93IHRvIHNlcmlhbGl6ZSB0aGUgcGF0aC5cbiAqIEByZXR1cm5zIFBhdGggcmVwcmVzZW50aW5nIHRoZSBzdGF0ZSwgZS5nLiAvZm9vL2Jhcj9jb3VudD00Mi5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZ2V0UGF0aEZyb21TdGF0ZShcbiAgc3RhdGU6IFN0YXRlLFxuICBvcHRpb25zPzogT3B0aW9uc1xuKTogc3RyaW5nIHtcbiAgaWYgKHN0YXRlID09IG51bGwpIHtcbiAgICB0aHJvdyBFcnJvcihcbiAgICAgIFwiR290ICd1bmRlZmluZWQnIGZvciB0aGUgbmF2aWdhdGlvbiBzdGF0ZS4gWW91IG11c3QgcGFzcyBhIHZhbGlkIHN0YXRlIG9iamVjdC5cIlxuICAgICk7XG4gIH1cblxuICBjb25zdCBbbGVnYWN5LCBjb21wYXRPcHRpb25zXSA9IGNoZWNrTGVnYWN5UGF0aENvbmZpZyhvcHRpb25zKTtcblxuICAvLyBDcmVhdGUgYSBub3JtYWxpemVkIGNvbmZpZ3Mgb2JqZWN0IHdoaWNoIHdpbGwgYmUgZWFzaWVyIHRvIHVzZVxuICBjb25zdCBjb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBDb25maWdJdGVtPiA9IGNvbXBhdE9wdGlvbnNcbiAgICA/IGNyZWF0ZU5vcm1hbGl6ZWRDb25maWdzKGxlZ2FjeSwgY29tcGF0T3B0aW9ucy5zY3JlZW5zKVxuICAgIDoge307XG5cbiAgbGV0IHBhdGggPSAnLyc7XG4gIGxldCBjdXJyZW50OiBTdGF0ZSB8IHVuZGVmaW5lZCA9IHN0YXRlO1xuXG4gIGNvbnN0IGFsbFBhcmFtczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuXG4gIHdoaWxlIChjdXJyZW50KSB7XG4gICAgbGV0IGluZGV4ID0gdHlwZW9mIGN1cnJlbnQuaW5kZXggPT09ICdudW1iZXInID8gY3VycmVudC5pbmRleCA6IDA7XG4gICAgbGV0IHJvdXRlID0gY3VycmVudC5yb3V0ZXNbaW5kZXhdIGFzIFJvdXRlPHN0cmluZz4gJiB7XG4gICAgICBzdGF0ZT86IFN0YXRlO1xuICAgIH07XG5cbiAgICBsZXQgcGF0dGVybjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgbGV0IGZvY3VzZWRQYXJhbXM6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG4gICAgbGV0IGZvY3VzZWRSb3V0ZSA9IGdldEFjdGl2ZVJvdXRlKHN0YXRlKTtcbiAgICBsZXQgY3VycmVudE9wdGlvbnMgPSBjb25maWdzO1xuXG4gICAgLy8gS2VlcCBhbGwgdGhlIHJvdXRlIG5hbWVzIHRoYXQgYXBwZWFyZWQgZHVyaW5nIGdvaW5nIGRlZXBlciBpbiBjb25maWcgaW4gY2FzZSB0aGUgcGF0dGVybiBpcyByZXNvbHZlZCB0byB1bmRlZmluZWRcbiAgICBsZXQgbmVzdGVkUm91dGVOYW1lcyA9IFtdO1xuXG4gICAgbGV0IGhhc05leHQgPSB0cnVlO1xuXG4gICAgd2hpbGUgKHJvdXRlLm5hbWUgaW4gY3VycmVudE9wdGlvbnMgJiYgaGFzTmV4dCkge1xuICAgICAgcGF0dGVybiA9IGN1cnJlbnRPcHRpb25zW3JvdXRlLm5hbWVdLnBhdHRlcm47XG5cbiAgICAgIG5lc3RlZFJvdXRlTmFtZXMucHVzaChyb3V0ZS5uYW1lKTtcblxuICAgICAgaWYgKHJvdXRlLnBhcmFtcykge1xuICAgICAgICBjb25zdCBzdHJpbmdpZnkgPSBjdXJyZW50T3B0aW9uc1tyb3V0ZS5uYW1lXT8uc3RyaW5naWZ5O1xuXG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXJhbXMgPSBmcm9tRW50cmllcyhcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhyb3V0ZS5wYXJhbXMpLm1hcCgoW2tleSwgdmFsdWVdKSA9PiBbXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICBzdHJpbmdpZnk/LltrZXldID8gc3RyaW5naWZ5W2tleV0odmFsdWUpIDogU3RyaW5nKHZhbHVlKSxcbiAgICAgICAgICBdKVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChwYXR0ZXJuKSB7XG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihhbGxQYXJhbXMsIGN1cnJlbnRQYXJhbXMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvY3VzZWRSb3V0ZSA9PT0gcm91dGUpIHtcbiAgICAgICAgICAvLyBJZiB0aGlzIGlzIHRoZSBmb2N1c2VkIHJvdXRlLCBrZWVwIHRoZSBwYXJhbXMgZm9yIGxhdGVyIHVzZVxuICAgICAgICAgIC8vIFdlIHNhdmUgaXQgaGVyZSBzaW5jZSBpdCdzIGJlZW4gc3RyaW5naWZpZWQgYWxyZWFkeVxuICAgICAgICAgIGZvY3VzZWRQYXJhbXMgPSB7IC4uLmN1cnJlbnRQYXJhbXMgfTtcblxuICAgICAgICAgIHBhdHRlcm5cbiAgICAgICAgICAgID8uc3BsaXQoJy8nKVxuICAgICAgICAgICAgLmZpbHRlcigocCkgPT4gcC5zdGFydHNXaXRoKCc6JykpXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbG9vcC1mdW5jXG4gICAgICAgICAgICAuZm9yRWFjaCgocCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBuYW1lID0gZ2V0UGFyYW1OYW1lKHApO1xuXG4gICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgcGFyYW1zIHByZXNlbnQgaW4gdGhlIHBhdHRlcm4gc2luY2Ugd2UnbGwgb25seSB1c2UgdGhlIHJlc3QgZm9yIHF1ZXJ5IHN0cmluZ1xuICAgICAgICAgICAgICBpZiAoZm9jdXNlZFBhcmFtcykge1xuICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZHluYW1pYy1kZWxldGVcbiAgICAgICAgICAgICAgICBkZWxldGUgZm9jdXNlZFBhcmFtc1tuYW1lXTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYHNjcmVlbnNgIHByb3BlcnR5IG9yIG5vIG5lc3RlZCBzdGF0ZSwgd2UgcmV0dXJuIHBhdHRlcm5cbiAgICAgIGlmICghY3VycmVudE9wdGlvbnNbcm91dGUubmFtZV0uc2NyZWVucyB8fCByb3V0ZS5zdGF0ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGhhc05leHQgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGluZGV4ID1cbiAgICAgICAgICB0eXBlb2Ygcm91dGUuc3RhdGUuaW5kZXggPT09ICdudW1iZXInXG4gICAgICAgICAgICA/IHJvdXRlLnN0YXRlLmluZGV4XG4gICAgICAgICAgICA6IHJvdXRlLnN0YXRlLnJvdXRlcy5sZW5ndGggLSAxO1xuXG4gICAgICAgIGNvbnN0IG5leHRSb3V0ZSA9IHJvdXRlLnN0YXRlLnJvdXRlc1tpbmRleF07XG4gICAgICAgIGNvbnN0IG5lc3RlZENvbmZpZyA9IGN1cnJlbnRPcHRpb25zW3JvdXRlLm5hbWVdLnNjcmVlbnM7XG5cbiAgICAgICAgLy8gaWYgdGhlcmUgaXMgY29uZmlnIGZvciBuZXh0IHJvdXRlIG5hbWUsIHdlIGdvIGRlZXBlclxuICAgICAgICBpZiAobmVzdGVkQ29uZmlnICYmIG5leHRSb3V0ZS5uYW1lIGluIG5lc3RlZENvbmZpZykge1xuICAgICAgICAgIHJvdXRlID0gbmV4dFJvdXRlIGFzIFJvdXRlPHN0cmluZz4gJiB7IHN0YXRlPzogU3RhdGUgfTtcbiAgICAgICAgICBjdXJyZW50T3B0aW9ucyA9IG5lc3RlZENvbmZpZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBJZiBub3QsIHRoZXJlIGlzIG5vIHNlbnNlIGluIGdvaW5nIGRlZXBlciBpbiBjb25maWdcbiAgICAgICAgICBoYXNOZXh0ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocGF0dGVybiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXR0ZXJuID0gbmVzdGVkUm91dGVOYW1lcy5qb2luKCcvJyk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRPcHRpb25zW3JvdXRlLm5hbWVdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHBhdGggKz0gcGF0dGVyblxuICAgICAgICAuc3BsaXQoJy8nKVxuICAgICAgICAubWFwKChwKSA9PiB7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IGdldFBhcmFtTmFtZShwKTtcblxuICAgICAgICAgIC8vIFdlIGRvbid0IGtub3cgd2hhdCB0byBzaG93IGZvciB3aWxkY2FyZCBwYXR0ZXJuc1xuICAgICAgICAgIC8vIFNob3dpbmcgdGhlIHJvdXRlIG5hbWUgc2VlbXMgb2ssIHRob3VnaCB3aGF0ZXZlciB3ZSBzaG93IGhlcmUgd2lsbCBiZSBpbmNvcnJlY3RcbiAgICAgICAgICAvLyBTaW5jZSB0aGUgcGFnZSBkb2Vzbid0IGFjdHVhbGx5IGV4aXN0XG4gICAgICAgICAgaWYgKHAgPT09ICcqJykge1xuICAgICAgICAgICAgaWYgKGxlZ2FjeSkge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgXCJQbGVhc2UgdXBkYXRlIHlvdXIgY29uZmlnIHRvIHRoZSBuZXcgZm9ybWF0IHRvIHVzZSB3aWxkY2FyZCBwYXR0ZXJuICgnKicpLiBodHRwczovL3JlYWN0bmF2aWdhdGlvbi5vcmcvZG9jcy81LngvY29uZmlndXJpbmctbGlua3MvI3VwZGF0aW5nLWNvbmZpZ1wiXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByb3V0ZS5uYW1lO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIElmIHRoZSBwYXRoIGhhcyBhIHBhdHRlcm4gZm9yIGEgcGFyYW0sIHB1dCB0aGUgcGFyYW0gaW4gdGhlIHBhdGhcbiAgICAgICAgICBpZiAocC5zdGFydHNXaXRoKCc6JykpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYWxsUGFyYW1zW25hbWVdO1xuXG4gICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBwLmVuZHNXaXRoKCc/JykpIHtcbiAgICAgICAgICAgICAgLy8gT3B0aW9uYWwgcGFyYW1zIHdpdGhvdXQgdmFsdWUgYXNzaWduZWQgaW4gcm91dGUucGFyYW1zIHNob3VsZCBiZSBpZ25vcmVkXG4gICAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChwKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJy8nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0aCArPSBlbmNvZGVVUklDb21wb25lbnQocm91dGUubmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKCFmb2N1c2VkUGFyYW1zKSB7XG4gICAgICBmb2N1c2VkUGFyYW1zID0gZm9jdXNlZFJvdXRlLnBhcmFtcztcbiAgICB9XG5cbiAgICBpZiAocm91dGUuc3RhdGUpIHtcbiAgICAgIHBhdGggKz0gJy8nO1xuICAgIH0gZWxzZSBpZiAoZm9jdXNlZFBhcmFtcykge1xuICAgICAgZm9yIChsZXQgcGFyYW0gaW4gZm9jdXNlZFBhcmFtcykge1xuICAgICAgICBpZiAoZm9jdXNlZFBhcmFtc1twYXJhbV0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1keW5hbWljLWRlbGV0ZVxuICAgICAgICAgIGRlbGV0ZSBmb2N1c2VkUGFyYW1zW3BhcmFtXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBxdWVyeSA9IHF1ZXJ5U3RyaW5nLnN0cmluZ2lmeShmb2N1c2VkUGFyYW1zKTtcblxuICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgIHBhdGggKz0gYD8ke3F1ZXJ5fWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY3VycmVudCA9IHJvdXRlLnN0YXRlO1xuICB9XG5cbiAgLy8gUmVtb3ZlIG11bHRpcGxlIGFzIHdlbGwgYXMgdHJhaWxpbmcgc2xhc2hlc1xuICBwYXRoID0gcGF0aC5yZXBsYWNlKC9cXC8rL2csICcvJyk7XG4gIHBhdGggPSBwYXRoLmxlbmd0aCA+IDEgPyBwYXRoLnJlcGxhY2UoL1xcLyQvLCAnJykgOiBwYXRoO1xuXG4gIHJldHVybiBwYXRoO1xufVxuXG4vLyBPYmplY3QuZnJvbUVudHJpZXMgaXMgbm90IGF2YWlsYWJsZSBpbiBvbGRlciBpT1MgdmVyc2lvbnNcbmNvbnN0IGZyb21FbnRyaWVzID0gPEsgZXh0ZW5kcyBzdHJpbmcsIFY+KGVudHJpZXM6IChyZWFkb25seSBbSywgVl0pW10pID0+XG4gIGVudHJpZXMucmVkdWNlKChhY2MsIFtrLCB2XSkgPT4ge1xuICAgIGlmIChhY2MuaGFzT3duUHJvcGVydHkoaykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSB2YWx1ZSBmb3Iga2V5ICcke2t9JyBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgb2JqZWN0LmApO1xuICAgIH1cblxuICAgIGFjY1trXSA9IHY7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30gYXMgUmVjb3JkPEssIFY+KTtcblxuY29uc3QgZ2V0UGFyYW1OYW1lID0gKHBhdHRlcm46IHN0cmluZykgPT5cbiAgcGF0dGVybi5yZXBsYWNlKC9eOi8sICcnKS5yZXBsYWNlKC9cXD8kLywgJycpO1xuXG5jb25zdCBqb2luUGF0aHMgPSAoLi4ucGF0aHM6IHN0cmluZ1tdKTogc3RyaW5nID0+XG4gIChbXSBhcyBzdHJpbmdbXSlcbiAgICAuY29uY2F0KC4uLnBhdGhzLm1hcCgocCkgPT4gcC5zcGxpdCgnLycpKSlcbiAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgLmpvaW4oJy8nKTtcblxuY29uc3QgY3JlYXRlQ29uZmlnSXRlbSA9IChcbiAgbGVnYWN5OiBib29sZWFuLFxuICBjb25maWc6IFBhdGhDb25maWcgfCBzdHJpbmcsXG4gIHBhcmVudFBhdHRlcm4/OiBzdHJpbmdcbik6IENvbmZpZ0l0ZW0gPT4ge1xuICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHtcbiAgICAvLyBJZiBhIHN0cmluZyBpcyBzcGVjaWZpZWQgYXMgdGhlIHZhbHVlIG9mIHRoZSBrZXkoZS5nLiBGb286ICcvcGF0aCcpLCB1c2UgaXQgYXMgdGhlIHBhdHRlcm5cbiAgICBjb25zdCBwYXR0ZXJuID0gcGFyZW50UGF0dGVybiA/IGpvaW5QYXRocyhwYXJlbnRQYXR0ZXJuLCBjb25maWcpIDogY29uZmlnO1xuXG4gICAgcmV0dXJuIHsgcGF0dGVybiB9O1xuICB9XG5cbiAgLy8gSWYgYW4gb2JqZWN0IGlzIHNwZWNpZmllZCBhcyB0aGUgdmFsdWUgKGUuZy4gRm9vOiB7IC4uLiB9KSxcbiAgLy8gSXQgY2FuIGhhdmUgYHBhdGhgIHByb3BlcnR5IGFuZCBgc2NyZWVuc2AgcHJvcCB3aGljaCBoYXMgbmVzdGVkIGNvbmZpZ3NcbiAgbGV0IHBhdHRlcm46IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBpZiAobGVnYWN5KSB7XG4gICAgcGF0dGVybiA9XG4gICAgICBjb25maWcuZXhhY3QgIT09IHRydWUgJiYgcGFyZW50UGF0dGVybiAmJiBjb25maWcucGF0aFxuICAgICAgICA/IGpvaW5QYXRocyhwYXJlbnRQYXR0ZXJuLCBjb25maWcucGF0aClcbiAgICAgICAgOiBjb25maWcucGF0aDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoY29uZmlnLmV4YWN0ICYmIGNvbmZpZy5wYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJBICdwYXRoJyBuZWVkcyB0byBiZSBzcGVjaWZpZWQgd2hlbiBzcGVjaWZ5aW5nICdleGFjdDogdHJ1ZScuIElmIHlvdSBkb24ndCB3YW50IHRoaXMgc2NyZWVuIGluIHRoZSBVUkwsIHNwZWNpZnkgaXQgYXMgZW1wdHkgc3RyaW5nLCBlLmcuIGBwYXRoOiAnJ2AuXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcGF0dGVybiA9XG4gICAgICBjb25maWcuZXhhY3QgIT09IHRydWVcbiAgICAgICAgPyBqb2luUGF0aHMocGFyZW50UGF0dGVybiB8fCAnJywgY29uZmlnLnBhdGggfHwgJycpXG4gICAgICAgIDogY29uZmlnLnBhdGggfHwgJyc7XG4gIH1cblxuICBjb25zdCBzY3JlZW5zID0gY29uZmlnLnNjcmVlbnNcbiAgICA/IGNyZWF0ZU5vcm1hbGl6ZWRDb25maWdzKGxlZ2FjeSwgY29uZmlnLnNjcmVlbnMsIHBhdHRlcm4pXG4gICAgOiB1bmRlZmluZWQ7XG5cbiAgcmV0dXJuIHtcbiAgICAvLyBOb3JtYWxpemUgcGF0dGVybiB0byByZW1vdmUgYW55IGxlYWRpbmcsIHRyYWlsaW5nIHNsYXNoZXMsIGR1cGxpY2F0ZSBzbGFzaGVzIGV0Yy5cbiAgICBwYXR0ZXJuOiBwYXR0ZXJuPy5zcGxpdCgnLycpLmZpbHRlcihCb29sZWFuKS5qb2luKCcvJyksXG4gICAgc3RyaW5naWZ5OiBjb25maWcuc3RyaW5naWZ5LFxuICAgIHNjcmVlbnMsXG4gIH07XG59O1xuXG5jb25zdCBjcmVhdGVOb3JtYWxpemVkQ29uZmlncyA9IChcbiAgbGVnYWN5OiBib29sZWFuLFxuICBvcHRpb25zOiBQYXRoQ29uZmlnTWFwLFxuICBwYXR0ZXJuPzogc3RyaW5nXG4pOiBSZWNvcmQ8c3RyaW5nLCBDb25maWdJdGVtPiA9PlxuICBmcm9tRW50cmllcyhcbiAgICBPYmplY3QuZW50cmllcyhvcHRpb25zKS5tYXAoKFtuYW1lLCBjXSkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gY3JlYXRlQ29uZmlnSXRlbShsZWdhY3ksIGMsIHBhdHRlcm4pO1xuXG4gICAgICByZXR1cm4gW25hbWUsIHJlc3VsdF07XG4gICAgfSlcbiAgKTtcbiJdfQ==
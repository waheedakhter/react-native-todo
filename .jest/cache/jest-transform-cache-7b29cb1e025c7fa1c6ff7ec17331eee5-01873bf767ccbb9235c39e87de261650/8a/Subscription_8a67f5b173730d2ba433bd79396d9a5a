2a3d4e4c5265ea5131879c99edea9afd
"use strict";

exports.__esModule = true;
exports.createSubscription = createSubscription;

var _batch = require("./batch");

function createListenerCollection() {
  var batch = (0, _batch.getBatch)();
  var first = null;
  var last = null;
  return {
    clear: function clear() {
      first = null;
      last = null;
    },
    notify: function notify() {
      batch(function () {
        var listener = first;

        while (listener) {
          listener.callback();
          listener = listener.next;
        }
      });
    },
    get: function get() {
      var listeners = [];
      var listener = first;

      while (listener) {
        listeners.push(listener);
        listener = listener.next;
      }

      return listeners;
    },
    subscribe: function subscribe(callback) {
      var isSubscribed = true;
      var listener = last = {
        callback: callback,
        next: null,
        prev: last
      };

      if (listener.prev) {
        listener.prev.next = listener;
      } else {
        first = listener;
      }

      return function unsubscribe() {
        if (!isSubscribed || first === null) return;
        isSubscribed = false;

        if (listener.next) {
          listener.next.prev = listener.prev;
        } else {
          last = listener.prev;
        }

        if (listener.prev) {
          listener.prev.next = listener.next;
        } else {
          first = listener.next;
        }
      };
    }
  };
}

var nullListeners = {
  notify: function notify() {},
  get: function get() {
    return [];
  }
};

function createSubscription(store, parentSub) {
  var unsubscribe;
  var listeners = nullListeners;

  function addNestedSub(listener) {
    trySubscribe();
    return listeners.subscribe(listener);
  }

  function notifyNestedSubs() {
    listeners.notify();
  }

  function handleChangeWrapper() {
    if (subscription.onStateChange) {
      subscription.onStateChange();
    }
  }

  function isSubscribed() {
    return Boolean(unsubscribe);
  }

  function trySubscribe() {
    if (!unsubscribe) {
      unsubscribe = parentSub ? parentSub.addNestedSub(handleChangeWrapper) : store.subscribe(handleChangeWrapper);
      listeners = createListenerCollection();
    }
  }

  function tryUnsubscribe() {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = undefined;
      listeners.clear();
      listeners = nullListeners;
    }
  }

  var subscription = {
    addNestedSub: addNestedSub,
    notifyNestedSubs: notifyNestedSubs,
    handleChangeWrapper: handleChangeWrapper,
    isSubscribed: isSubscribed,
    trySubscribe: trySubscribe,
    tryUnsubscribe: tryUnsubscribe,
    getListeners: function getListeners() {
      return listeners;
    }
  };
  return subscription;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN1YnNjcmlwdGlvbi5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwiX19lc01vZHVsZSIsImNyZWF0ZVN1YnNjcmlwdGlvbiIsIl9iYXRjaCIsInJlcXVpcmUiLCJjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24iLCJiYXRjaCIsImdldEJhdGNoIiwiZmlyc3QiLCJsYXN0IiwiY2xlYXIiLCJub3RpZnkiLCJsaXN0ZW5lciIsImNhbGxiYWNrIiwibmV4dCIsImdldCIsImxpc3RlbmVycyIsInB1c2giLCJzdWJzY3JpYmUiLCJpc1N1YnNjcmliZWQiLCJwcmV2IiwidW5zdWJzY3JpYmUiLCJudWxsTGlzdGVuZXJzIiwic3RvcmUiLCJwYXJlbnRTdWIiLCJhZGROZXN0ZWRTdWIiLCJ0cnlTdWJzY3JpYmUiLCJub3RpZnlOZXN0ZWRTdWJzIiwiaGFuZGxlQ2hhbmdlV3JhcHBlciIsInN1YnNjcmlwdGlvbiIsIm9uU3RhdGVDaGFuZ2UiLCJCb29sZWFuIiwidHJ5VW5zdWJzY3JpYmUiLCJ1bmRlZmluZWQiLCJnZXRMaXN0ZW5lcnMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxPQUFPLENBQUNDLFVBQVIsR0FBcUIsSUFBckI7QUFDQUQsT0FBTyxDQUFDRSxrQkFBUixHQUE2QkEsa0JBQTdCOztBQUVBLElBQUlDLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBcEI7O0FBS0EsU0FBU0Msd0JBQVQsR0FBb0M7QUFDbEMsTUFBSUMsS0FBSyxHQUFHLENBQUMsR0FBR0gsTUFBTSxDQUFDSSxRQUFYLEdBQVo7QUFDQSxNQUFJQyxLQUFLLEdBQUcsSUFBWjtBQUNBLE1BQUlDLElBQUksR0FBRyxJQUFYO0FBQ0EsU0FBTztBQUNMQyxJQUFBQSxLQUFLLEVBQUUsU0FBU0EsS0FBVCxHQUFpQjtBQUN0QkYsTUFBQUEsS0FBSyxHQUFHLElBQVI7QUFDQUMsTUFBQUEsSUFBSSxHQUFHLElBQVA7QUFDRCxLQUpJO0FBS0xFLElBQUFBLE1BQU0sRUFBRSxTQUFTQSxNQUFULEdBQWtCO0FBQ3hCTCxNQUFBQSxLQUFLLENBQUMsWUFBWTtBQUNoQixZQUFJTSxRQUFRLEdBQUdKLEtBQWY7O0FBRUEsZUFBT0ksUUFBUCxFQUFpQjtBQUNmQSxVQUFBQSxRQUFRLENBQUNDLFFBQVQ7QUFDQUQsVUFBQUEsUUFBUSxHQUFHQSxRQUFRLENBQUNFLElBQXBCO0FBQ0Q7QUFDRixPQVBJLENBQUw7QUFRRCxLQWRJO0FBZUxDLElBQUFBLEdBQUcsRUFBRSxTQUFTQSxHQUFULEdBQWU7QUFDbEIsVUFBSUMsU0FBUyxHQUFHLEVBQWhCO0FBQ0EsVUFBSUosUUFBUSxHQUFHSixLQUFmOztBQUVBLGFBQU9JLFFBQVAsRUFBaUI7QUFDZkksUUFBQUEsU0FBUyxDQUFDQyxJQUFWLENBQWVMLFFBQWY7QUFDQUEsUUFBQUEsUUFBUSxHQUFHQSxRQUFRLENBQUNFLElBQXBCO0FBQ0Q7O0FBRUQsYUFBT0UsU0FBUDtBQUNELEtBekJJO0FBMEJMRSxJQUFBQSxTQUFTLEVBQUUsU0FBU0EsU0FBVCxDQUFtQkwsUUFBbkIsRUFBNkI7QUFDdEMsVUFBSU0sWUFBWSxHQUFHLElBQW5CO0FBQ0EsVUFBSVAsUUFBUSxHQUFHSCxJQUFJLEdBQUc7QUFDcEJJLFFBQUFBLFFBQVEsRUFBRUEsUUFEVTtBQUVwQkMsUUFBQUEsSUFBSSxFQUFFLElBRmM7QUFHcEJNLFFBQUFBLElBQUksRUFBRVg7QUFIYyxPQUF0Qjs7QUFNQSxVQUFJRyxRQUFRLENBQUNRLElBQWIsRUFBbUI7QUFDakJSLFFBQUFBLFFBQVEsQ0FBQ1EsSUFBVCxDQUFjTixJQUFkLEdBQXFCRixRQUFyQjtBQUNELE9BRkQsTUFFTztBQUNMSixRQUFBQSxLQUFLLEdBQUdJLFFBQVI7QUFDRDs7QUFFRCxhQUFPLFNBQVNTLFdBQVQsR0FBdUI7QUFDNUIsWUFBSSxDQUFDRixZQUFELElBQWlCWCxLQUFLLEtBQUssSUFBL0IsRUFBcUM7QUFDckNXLFFBQUFBLFlBQVksR0FBRyxLQUFmOztBQUVBLFlBQUlQLFFBQVEsQ0FBQ0UsSUFBYixFQUFtQjtBQUNqQkYsVUFBQUEsUUFBUSxDQUFDRSxJQUFULENBQWNNLElBQWQsR0FBcUJSLFFBQVEsQ0FBQ1EsSUFBOUI7QUFDRCxTQUZELE1BRU87QUFDTFgsVUFBQUEsSUFBSSxHQUFHRyxRQUFRLENBQUNRLElBQWhCO0FBQ0Q7O0FBRUQsWUFBSVIsUUFBUSxDQUFDUSxJQUFiLEVBQW1CO0FBQ2pCUixVQUFBQSxRQUFRLENBQUNRLElBQVQsQ0FBY04sSUFBZCxHQUFxQkYsUUFBUSxDQUFDRSxJQUE5QjtBQUNELFNBRkQsTUFFTztBQUNMTixVQUFBQSxLQUFLLEdBQUdJLFFBQVEsQ0FBQ0UsSUFBakI7QUFDRDtBQUNGLE9BZkQ7QUFnQkQ7QUF4REksR0FBUDtBQTBERDs7QUFFRCxJQUFJUSxhQUFhLEdBQUc7QUFDbEJYLEVBQUFBLE1BQU0sRUFBRSxTQUFTQSxNQUFULEdBQWtCLENBQUUsQ0FEVjtBQUVsQkksRUFBQUEsR0FBRyxFQUFFLFNBQVNBLEdBQVQsR0FBZTtBQUNsQixXQUFPLEVBQVA7QUFDRDtBQUppQixDQUFwQjs7QUFPQSxTQUFTYixrQkFBVCxDQUE0QnFCLEtBQTVCLEVBQW1DQyxTQUFuQyxFQUE4QztBQUM1QyxNQUFJSCxXQUFKO0FBQ0EsTUFBSUwsU0FBUyxHQUFHTSxhQUFoQjs7QUFFQSxXQUFTRyxZQUFULENBQXNCYixRQUF0QixFQUFnQztBQUM5QmMsSUFBQUEsWUFBWTtBQUNaLFdBQU9WLFNBQVMsQ0FBQ0UsU0FBVixDQUFvQk4sUUFBcEIsQ0FBUDtBQUNEOztBQUVELFdBQVNlLGdCQUFULEdBQTRCO0FBQzFCWCxJQUFBQSxTQUFTLENBQUNMLE1BQVY7QUFDRDs7QUFFRCxXQUFTaUIsbUJBQVQsR0FBK0I7QUFDN0IsUUFBSUMsWUFBWSxDQUFDQyxhQUFqQixFQUFnQztBQUM5QkQsTUFBQUEsWUFBWSxDQUFDQyxhQUFiO0FBQ0Q7QUFDRjs7QUFFRCxXQUFTWCxZQUFULEdBQXdCO0FBQ3RCLFdBQU9ZLE9BQU8sQ0FBQ1YsV0FBRCxDQUFkO0FBQ0Q7O0FBRUQsV0FBU0ssWUFBVCxHQUF3QjtBQUN0QixRQUFJLENBQUNMLFdBQUwsRUFBa0I7QUFDaEJBLE1BQUFBLFdBQVcsR0FBR0csU0FBUyxHQUFHQSxTQUFTLENBQUNDLFlBQVYsQ0FBdUJHLG1CQUF2QixDQUFILEdBQWlETCxLQUFLLENBQUNMLFNBQU4sQ0FBZ0JVLG1CQUFoQixDQUF4RTtBQUNBWixNQUFBQSxTQUFTLEdBQUdYLHdCQUF3QixFQUFwQztBQUNEO0FBQ0Y7O0FBRUQsV0FBUzJCLGNBQVQsR0FBMEI7QUFDeEIsUUFBSVgsV0FBSixFQUFpQjtBQUNmQSxNQUFBQSxXQUFXO0FBQ1hBLE1BQUFBLFdBQVcsR0FBR1ksU0FBZDtBQUNBakIsTUFBQUEsU0FBUyxDQUFDTixLQUFWO0FBQ0FNLE1BQUFBLFNBQVMsR0FBR00sYUFBWjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSU8sWUFBWSxHQUFHO0FBQ2pCSixJQUFBQSxZQUFZLEVBQUVBLFlBREc7QUFFakJFLElBQUFBLGdCQUFnQixFQUFFQSxnQkFGRDtBQUdqQkMsSUFBQUEsbUJBQW1CLEVBQUVBLG1CQUhKO0FBSWpCVCxJQUFBQSxZQUFZLEVBQUVBLFlBSkc7QUFLakJPLElBQUFBLFlBQVksRUFBRUEsWUFMRztBQU1qQk0sSUFBQUEsY0FBYyxFQUFFQSxjQU5DO0FBT2pCRSxJQUFBQSxZQUFZLEVBQUUsU0FBU0EsWUFBVCxHQUF3QjtBQUNwQyxhQUFPbEIsU0FBUDtBQUNEO0FBVGdCLEdBQW5CO0FBV0EsU0FBT2EsWUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzLmNyZWF0ZVN1YnNjcmlwdGlvbiA9IGNyZWF0ZVN1YnNjcmlwdGlvbjtcblxudmFyIF9iYXRjaCA9IHJlcXVpcmUoXCIuL2JhdGNoXCIpO1xuXG4vLyBlbmNhcHN1bGF0ZXMgdGhlIHN1YnNjcmlwdGlvbiBsb2dpYyBmb3IgY29ubmVjdGluZyBhIGNvbXBvbmVudCB0byB0aGUgcmVkdXggc3RvcmUsIGFzXG4vLyB3ZWxsIGFzIG5lc3Rpbmcgc3Vic2NyaXB0aW9ucyBvZiBkZXNjZW5kYW50IGNvbXBvbmVudHMsIHNvIHRoYXQgd2UgY2FuIGVuc3VyZSB0aGVcbi8vIGFuY2VzdG9yIGNvbXBvbmVudHMgcmUtcmVuZGVyIGJlZm9yZSBkZXNjZW5kYW50c1xuZnVuY3Rpb24gY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uKCkge1xuICB2YXIgYmF0Y2ggPSAoMCwgX2JhdGNoLmdldEJhdGNoKSgpO1xuICB2YXIgZmlyc3QgPSBudWxsO1xuICB2YXIgbGFzdCA9IG51bGw7XG4gIHJldHVybiB7XG4gICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkge1xuICAgICAgZmlyc3QgPSBudWxsO1xuICAgICAgbGFzdCA9IG51bGw7XG4gICAgfSxcbiAgICBub3RpZnk6IGZ1bmN0aW9uIG5vdGlmeSgpIHtcbiAgICAgIGJhdGNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGxpc3RlbmVyID0gZmlyc3Q7XG5cbiAgICAgICAgd2hpbGUgKGxpc3RlbmVyKSB7XG4gICAgICAgICAgbGlzdGVuZXIuY2FsbGJhY2soKTtcbiAgICAgICAgICBsaXN0ZW5lciA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sXG4gICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7XG4gICAgICB2YXIgbGlzdGVuZXJzID0gW107XG4gICAgICB2YXIgbGlzdGVuZXIgPSBmaXJzdDtcblxuICAgICAgd2hpbGUgKGxpc3RlbmVyKSB7XG4gICAgICAgIGxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTtcbiAgICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbGlzdGVuZXJzO1xuICAgIH0sXG4gICAgc3Vic2NyaWJlOiBmdW5jdGlvbiBzdWJzY3JpYmUoY2FsbGJhY2spIHtcbiAgICAgIHZhciBpc1N1YnNjcmliZWQgPSB0cnVlO1xuICAgICAgdmFyIGxpc3RlbmVyID0gbGFzdCA9IHtcbiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLFxuICAgICAgICBuZXh0OiBudWxsLFxuICAgICAgICBwcmV2OiBsYXN0XG4gICAgICB9O1xuXG4gICAgICBpZiAobGlzdGVuZXIucHJldikge1xuICAgICAgICBsaXN0ZW5lci5wcmV2Lm5leHQgPSBsaXN0ZW5lcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcnN0ID0gbGlzdGVuZXI7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHtcbiAgICAgICAgaWYgKCFpc1N1YnNjcmliZWQgfHwgZmlyc3QgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgaXNTdWJzY3JpYmVkID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyLm5leHQpIHtcbiAgICAgICAgICBsaXN0ZW5lci5uZXh0LnByZXYgPSBsaXN0ZW5lci5wcmV2O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxhc3QgPSBsaXN0ZW5lci5wcmV2O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyLnByZXYpIHtcbiAgICAgICAgICBsaXN0ZW5lci5wcmV2Lm5leHQgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZpcnN0ID0gbGlzdGVuZXIubmV4dDtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gIH07XG59XG5cbnZhciBudWxsTGlzdGVuZXJzID0ge1xuICBub3RpZnk6IGZ1bmN0aW9uIG5vdGlmeSgpIHt9LFxuICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHtcbiAgICByZXR1cm4gW107XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGNyZWF0ZVN1YnNjcmlwdGlvbihzdG9yZSwgcGFyZW50U3ViKSB7XG4gIHZhciB1bnN1YnNjcmliZTtcbiAgdmFyIGxpc3RlbmVycyA9IG51bGxMaXN0ZW5lcnM7XG5cbiAgZnVuY3Rpb24gYWRkTmVzdGVkU3ViKGxpc3RlbmVyKSB7XG4gICAgdHJ5U3Vic2NyaWJlKCk7XG4gICAgcmV0dXJuIGxpc3RlbmVycy5zdWJzY3JpYmUobGlzdGVuZXIpO1xuICB9XG5cbiAgZnVuY3Rpb24gbm90aWZ5TmVzdGVkU3VicygpIHtcbiAgICBsaXN0ZW5lcnMubm90aWZ5KCk7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVDaGFuZ2VXcmFwcGVyKCkge1xuICAgIGlmIChzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSkge1xuICAgICAgc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UoKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBpc1N1YnNjcmliZWQoKSB7XG4gICAgcmV0dXJuIEJvb2xlYW4odW5zdWJzY3JpYmUpO1xuICB9XG5cbiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlKCkge1xuICAgIGlmICghdW5zdWJzY3JpYmUpIHtcbiAgICAgIHVuc3Vic2NyaWJlID0gcGFyZW50U3ViID8gcGFyZW50U3ViLmFkZE5lc3RlZFN1YihoYW5kbGVDaGFuZ2VXcmFwcGVyKSA6IHN0b3JlLnN1YnNjcmliZShoYW5kbGVDaGFuZ2VXcmFwcGVyKTtcbiAgICAgIGxpc3RlbmVycyA9IGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHRyeVVuc3Vic2NyaWJlKCkge1xuICAgIGlmICh1bnN1YnNjcmliZSkge1xuICAgICAgdW5zdWJzY3JpYmUoKTtcbiAgICAgIHVuc3Vic2NyaWJlID0gdW5kZWZpbmVkO1xuICAgICAgbGlzdGVuZXJzLmNsZWFyKCk7XG4gICAgICBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzO1xuICAgIH1cbiAgfVxuXG4gIHZhciBzdWJzY3JpcHRpb24gPSB7XG4gICAgYWRkTmVzdGVkU3ViOiBhZGROZXN0ZWRTdWIsXG4gICAgbm90aWZ5TmVzdGVkU3Viczogbm90aWZ5TmVzdGVkU3VicyxcbiAgICBoYW5kbGVDaGFuZ2VXcmFwcGVyOiBoYW5kbGVDaGFuZ2VXcmFwcGVyLFxuICAgIGlzU3Vic2NyaWJlZDogaXNTdWJzY3JpYmVkLFxuICAgIHRyeVN1YnNjcmliZTogdHJ5U3Vic2NyaWJlLFxuICAgIHRyeVVuc3Vic2NyaWJlOiB0cnlVbnN1YnNjcmliZSxcbiAgICBnZXRMaXN0ZW5lcnM6IGZ1bmN0aW9uIGdldExpc3RlbmVycygpIHtcbiAgICAgIHJldHVybiBsaXN0ZW5lcnM7XG4gICAgfVxuICB9O1xuICByZXR1cm4gc3Vic2NyaXB0aW9uO1xufSJdfQ==
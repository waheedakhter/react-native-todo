ea23be7a6a134f7e70a8d0eb46dbd712
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault2(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault2(require("@babel/runtime/helpers/createClass"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getCallID = getCallID;
exports.setCallID = setCallID;
exports.default = void 0;

var _ReanimatedModule = _interopRequireDefault(require("../ReanimatedModule"));

var _reactNative = require("react-native");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

var UPDATED_NODES = [];
var loopID = 1;
var propUpdatesEnqueued = null;
var nodeCount = 0;
var callID = "";

function getCallID() {
  return callID;
}

function setCallID(nextCallID) {
  callID = nextCallID;
}

function sanitizeConfig(config) {
  if (_reactNative.Platform.OS === 'web' || _reactNative.Platform.OS === 'windows' || _reactNative.Platform.OS === 'macos' || ['undefined', 'string', 'function', 'boolean', 'number'].includes(typeof config)) {
    return config;
  } else if (Array.isArray(config)) {
    return config.map(sanitizeConfig);
  } else if (config instanceof AnimatedNode) {
    return config.__nodeID;
  } else if (typeof config === 'object') {
    var output = {};

    for (var property in config) {
      if (property in config) {
        output[property] = sanitizeConfig(config[property]);
      }
    }

    return output;
  }

  return config;
}

function runPropUpdates() {
  var visitedNodes = new Set();

  var findAndUpdateNodes = function findAndUpdateNodes(node) {
    if (!node) {
      console.warn('findAndUpdateNodes was passed a nullish node');
      return;
    }

    if (visitedNodes.has(node)) {
      return;
    } else {
      visitedNodes.add(node);
    }

    if (typeof node.update === 'function') {
      node.update();
    } else {
      var nodes = node.__getChildren();

      if (nodes) {
        for (var i = 0, l = nodes.length; i < l; i++) {
          findAndUpdateNodes(nodes[i]);
        }
      }
    }
  };

  for (var i = 0; i < UPDATED_NODES.length; i++) {
    var node = UPDATED_NODES[i];
    findAndUpdateNodes(node);
  }

  UPDATED_NODES.length = 0;
  propUpdatesEnqueued = null;
  loopID += 1;
}

var scheduleUpdates = _reactNative.Platform.OS === 'web' ? requestAnimationFrame : setImmediate;

var AnimatedNode = function () {
  function AnimatedNode(nodeConfig, inputNodes) {
    (0, _classCallCheck2.default)(this, AnimatedNode);

    _defineProperty(this, "__nodeID", void 0);

    _defineProperty(this, "__lastLoopID", {
      "": -1
    });

    _defineProperty(this, "__memoizedValue", {
      "": null
    });

    _defineProperty(this, "__children", []);

    this.__nodeID = ++nodeCount;
    this.__nodeConfig = sanitizeConfig(nodeConfig);
    this.__initialized = false;
    this.__inputNodes = inputNodes && inputNodes.filter(function (node) {
      return node instanceof AnimatedNode;
    });
  }

  (0, _createClass2.default)(AnimatedNode, [{
    key: "toString",
    value: function toString() {
      return "AnimatedNode, id: ".concat(this.__nodeID);
    }
  }, {
    key: "__attach",
    value: function __attach() {
      this.__nativeInitialize();

      var nodes = this.__inputNodes;

      if (nodes) {
        for (var i = 0, l = nodes.length; i < l; i++) {
          nodes[i].__addChild(this);
        }
      }
    }
  }, {
    key: "__detach",
    value: function __detach() {
      var nodes = this.__inputNodes;

      if (nodes) {
        for (var i = 0, l = nodes.length; i < l; i++) {
          nodes[i].__removeChild(this);
        }
      }

      this.__nativeTearDown();
    }
  }, {
    key: "__getValue",
    value: function __getValue() {
      if (!(callID in this.__lastLoopID) || this.__lastLoopID[callID] < loopID) {
        this.__lastLoopID[callID] = loopID;

        var result = this.__onEvaluate();

        this.__memoizedValue[callID] = result;
        return result;
      }

      return this.__memoizedValue[callID];
    }
  }, {
    key: "__forceUpdateCache",
    value: function __forceUpdateCache(newValue) {
      this.__memoizedValue[callID] = newValue;

      this.__markUpdated();
    }
  }, {
    key: "__dangerouslyRescheduleEvaluate",
    value: function __dangerouslyRescheduleEvaluate() {
      this.__lastLoopID[callID] = -1;

      this.__markUpdated();
    }
  }, {
    key: "__markUpdated",
    value: function __markUpdated() {
      UPDATED_NODES.push(this);

      if (!propUpdatesEnqueued) {
        propUpdatesEnqueued = scheduleUpdates(runPropUpdates);
      }
    }
  }, {
    key: "__nativeInitialize",
    value: function __nativeInitialize() {
      if (!this.__initialized) {
        _ReanimatedModule.default.createNode(this.__nodeID, _objectSpread({}, this.__nodeConfig));

        this.__initialized = true;
      }
    }
  }, {
    key: "__nativeTearDown",
    value: function __nativeTearDown() {
      if (this.__initialized) {
        _ReanimatedModule.default.dropNode(this.__nodeID);

        this.__initialized = false;
      }
    }
  }, {
    key: "isNativelyInitialized",
    value: function isNativelyInitialized() {
      return this.__initialized;
    }
  }, {
    key: "__onEvaluate",
    value: function __onEvaluate() {
      throw new Error('Missing implementation of onEvaluate');
    }
  }, {
    key: "__getProps",
    value: function __getProps() {
      return this.__getValue();
    }
  }, {
    key: "__getChildren",
    value: function __getChildren() {
      return this.__children;
    }
  }, {
    key: "__addChild",
    value: function __addChild(child) {
      if (this.__children.length === 0) {
        this.__attach();
      }

      this.__children.push(child);

      child.__nativeInitialize();

      if (_ReanimatedModule.default.connectNodes) {
        _ReanimatedModule.default.connectNodes(this.__nodeID, child.__nodeID);
      } else {
        child.__dangerouslyRescheduleEvaluate();
      }
    }
  }, {
    key: "__removeChild",
    value: function __removeChild(child) {
      var index = this.__children.indexOf(child);

      if (index === -1) {
        console.warn("Trying to remove a child that doesn't exist");
        return;
      }

      if (_ReanimatedModule.default.disconnectNodes) {
        _ReanimatedModule.default.disconnectNodes(this.__nodeID, child.__nodeID);
      }

      this.__children.splice(index, 1);

      if (this.__children.length === 0) {
        this.__detach();
      }
    }
  }, {
    key: "_connectAnimatedView",
    value: function _connectAnimatedView(nativeViewTag) {
      if (_ReanimatedModule.default.connectNodeToView) {
        _ReanimatedModule.default.connectNodeToView(this.__nodeID, nativeViewTag);
      } else {
        this.__dangerouslyRescheduleEvaluate();
      }
    }
  }, {
    key: "_disconnectAnimatedView",
    value: function _disconnectAnimatedView(nativeViewTag) {
      _ReanimatedModule.default.disconnectNodeFromView(this.__nodeID, nativeViewTag);
    }
  }]);
  return AnimatedNode;
}();

exports.default = AnimatedNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFuaW1hdGVkTm9kZS5qcyJdLCJuYW1lcyI6WyJVUERBVEVEX05PREVTIiwibG9vcElEIiwicHJvcFVwZGF0ZXNFbnF1ZXVlZCIsIm5vZGVDb3VudCIsImNhbGxJRCIsIlBsYXRmb3JtIiwiQXJyYXkiLCJjb25maWciLCJvdXRwdXQiLCJwcm9wZXJ0eSIsInNhbml0aXplQ29uZmlnIiwidmlzaXRlZE5vZGVzIiwiZmluZEFuZFVwZGF0ZU5vZGVzIiwibm9kZSIsImNvbnNvbGUiLCJub2RlcyIsImkiLCJsIiwic2NoZWR1bGVVcGRhdGVzIiwiY29uc3RydWN0b3IiLCJpbnB1dE5vZGVzIiwidG9TdHJpbmciLCJfX2F0dGFjaCIsIl9fZGV0YWNoIiwiX19nZXRWYWx1ZSIsInJlc3VsdCIsIl9fZm9yY2VVcGRhdGVDYWNoZSIsIl9fZGFuZ2Vyb3VzbHlSZXNjaGVkdWxlRXZhbHVhdGUiLCJfX21hcmtVcGRhdGVkIiwiX19uYXRpdmVJbml0aWFsaXplIiwiUmVhbmltYXRlZE1vZHVsZSIsIl9fbmF0aXZlVGVhckRvd24iLCJpc05hdGl2ZWx5SW5pdGlhbGl6ZWQiLCJfX29uRXZhbHVhdGUiLCJfX2dldFByb3BzIiwiX19nZXRDaGlsZHJlbiIsIl9fYWRkQ2hpbGQiLCJjaGlsZCIsIl9fcmVtb3ZlQ2hpbGQiLCJpbmRleCIsIl9jb25uZWN0QW5pbWF0ZWRWaWV3IiwiX2Rpc2Nvbm5lY3RBbmltYXRlZFZpZXciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUEsaUJBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxxQkFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxZQUFBLEdBQUEsT0FBQSxDQUFBLGNBQUEsQ0FBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsYUFBYSxHQUFuQixFQUFBO0FBRUEsSUFBSUMsTUFBTSxHQUFWLENBQUE7QUFDQSxJQUFJQyxtQkFBbUIsR0FBdkIsSUFBQTtBQUNBLElBQUlDLFNBQVMsR0FBYixDQUFBO0FBQ0EsSUFBSUMsTUFBTSxHQUFWLEVBQUE7O0FBRU8sU0FBQSxTQUFBLEdBQXFCO0FBQzFCLFNBQUEsTUFBQTtBQUNEOztBQUVNLFNBQUEsU0FBQSxDQUFBLFVBQUEsRUFBK0I7QUFDcENBLEVBQUFBLE1BQU0sR0FBTkEsVUFBQUE7QUFDRDs7QUFFRCxTQUFBLGNBQUEsQ0FBQSxNQUFBLEVBQWdDO0FBQzlCLE1BQUlDLFlBQUFBLENBQUFBLFFBQUFBLENBQUFBLEVBQUFBLEtBQUFBLEtBQUFBLElBQXlCQSxZQUFBQSxDQUFBQSxRQUFBQSxDQUFBQSxFQUFBQSxLQUF6QkEsU0FBQUEsSUFBc0RBLFlBQUFBLENBQUFBLFFBQUFBLENBQUFBLEVBQUFBLEtBQXREQSxPQUFBQSxJQUFpRixDQUFBLFdBQUEsRUFBQSxRQUFBLEVBQUEsVUFBQSxFQUFBLFNBQUEsRUFBQSxRQUFBLEVBQUEsUUFBQSxDQUFrRSxPQUF2SixNQUFxRixDQUFyRixFQUF1SztBQUNySyxXQUFBLE1BQUE7QUFERixHQUFBLE1BRU8sSUFBSUMsS0FBSyxDQUFMQSxPQUFBQSxDQUFKLE1BQUlBLENBQUosRUFBMkI7QUFDaEMsV0FBT0MsTUFBTSxDQUFOQSxHQUFBQSxDQUFQLGNBQU9BLENBQVA7QUFESyxHQUFBLE1BRUEsSUFBSUEsTUFBTSxZQUFWLFlBQUEsRUFBb0M7QUFDekMsV0FBT0EsTUFBTSxDQUFiLFFBQUE7QUFESyxHQUFBLE1BRUEsSUFBSSxPQUFBLE1BQUEsS0FBSixRQUFBLEVBQWdDO0FBQ3JDLFFBQU1DLE1BQU0sR0FBWixFQUFBOztBQUNBLFNBQUssSUFBTCxRQUFBLElBQUEsTUFBQSxFQUErQjtBQUM3QixVQUFJQyxRQUFRLElBQVosTUFBQSxFQUF3QjtBQUN0QkQsUUFBQUEsTUFBTSxDQUFOQSxRQUFNLENBQU5BLEdBQW1CRSxjQUFjLENBQUNILE1BQU0sQ0FBeENDLFFBQXdDLENBQVAsQ0FBakNBO0FBQ0Q7QUFDRjs7QUFDRCxXQUFBLE1BQUE7QUFkNEI7O0FBaUI5QixTQUFBLE1BQUE7QUFDRDs7QUFFRCxTQUFBLGNBQUEsR0FBMEI7QUFDeEIsTUFBTUcsWUFBWSxHQUFHLElBQXJCLEdBQXFCLEVBQXJCOztBQUNBLE1BQU1DLGtCQUFrQixHQUFHQyxTQUFyQkQsa0JBQXFCQyxDQUFBQSxJQUFJLEVBQUk7QUFDakMsUUFBSSxDQUFKLElBQUEsRUFBVztBQUNUQyxNQUFBQSxPQUFPLENBQVBBLElBQUFBLENBQUFBLDhDQUFBQTtBQUNBO0FBQ0Q7O0FBRUQsUUFBSUgsWUFBWSxDQUFaQSxHQUFBQSxDQUFKLElBQUlBLENBQUosRUFBNEI7QUFDMUI7QUFERixLQUFBLE1BRU87QUFDTEEsTUFBQUEsWUFBWSxDQUFaQSxHQUFBQSxDQUFBQSxJQUFBQTtBQUNEOztBQUNELFFBQUksT0FBT0UsSUFBSSxDQUFYLE1BQUEsS0FBSixVQUFBLEVBQXVDO0FBQ3JDQSxNQUFBQSxJQUFJLENBQUpBLE1BQUFBO0FBREYsS0FBQSxNQUVPO0FBQ0wsVUFBTUUsS0FBSyxHQUFHRixJQUFJLENBQWxCLGFBQWNBLEVBQWQ7O0FBQ0EsVUFBQSxLQUFBLEVBQVc7QUFDVCxhQUFLLElBQUlHLENBQUMsR0FBTCxDQUFBLEVBQVdDLENBQUMsR0FBR0YsS0FBSyxDQUF6QixNQUFBLEVBQWtDQyxDQUFDLEdBQW5DLENBQUEsRUFBeUNBLENBQXpDLEVBQUEsRUFBOEM7QUFDNUNKLFVBQUFBLGtCQUFrQixDQUFDRyxLQUFLLENBQXhCSCxDQUF3QixDQUFOLENBQWxCQTtBQUNEO0FBQ0Y7QUFDRjtBQXBCSCxHQUFBOztBQXNCQSxPQUFLLElBQUlJLENBQUMsR0FBVixDQUFBLEVBQWdCQSxDQUFDLEdBQUdoQixhQUFhLENBQWpDLE1BQUEsRUFBMENnQixDQUExQyxFQUFBLEVBQStDO0FBQzdDLFFBQU1ILElBQUksR0FBR2IsYUFBYSxDQUExQixDQUEwQixDQUExQjtBQUNBWSxJQUFBQSxrQkFBa0IsQ0FBbEJBLElBQWtCLENBQWxCQTtBQUNEOztBQUNEWixFQUFBQSxhQUFhLENBQWJBLE1BQUFBLEdBNUJ3QixDQTRCeEJBO0FBQ0FFLEVBQUFBLG1CQUFtQixHQUFuQkEsSUFBQUE7QUFDQUQsRUFBQUEsTUFBTSxJQUFOQSxDQUFBQTtBQUNEOztBQUVELElBQU1pQixlQUFlLEdBQ25CYixZQUFBQSxDQUFBQSxRQUFBQSxDQUFBQSxFQUFBQSxLQUFBQSxLQUFBQSxHQUFBQSxxQkFBQUEsR0FERixZQUFBOztJQUdlLFk7QUFPYmMsd0JBQVcsVUFBWEEsRUFBVyxVQUFYQSxFQUFvQztBQUFBOztBQUFBLElBQUEsZUFBQSxDQUFBLElBQUEsRUFBQSxVQUFBLEVBQUEsS0FBQSxDQUFBLENBQUE7O0FBQUEsSUFBQSxlQUFBLENBQUEsSUFBQSxFQUFBLGNBQUEsRUFKckI7QUFBRSxVQUFJLENBQUM7QUFBUCxLQUlxQixDQUFBOztBQUFBLElBQUEsZUFBQSxDQUFBLElBQUEsRUFBQSxpQkFBQSxFQUhsQjtBQUFFLFVBQUk7QUFBTixLQUdrQixDQUFBOztBQUFBLElBQUEsZUFBQSxDQUFBLElBQUEsRUFBQSxZQUFBLEVBRnZCLEVBRXVCLENBQUE7O0FBQ2xDLFNBQUEsUUFBQSxHQUFnQixFQUFoQixTQUFBO0FBQ0EsU0FBQSxZQUFBLEdBQW9CVCxjQUFjLENBQWxDLFVBQWtDLENBQWxDO0FBQ0EsU0FBQSxhQUFBLEdBQUEsS0FBQTtBQUNBLFNBQUEsWUFBQSxHQUNFVSxVQUFVLElBQUlBLFVBQVUsQ0FBVkEsTUFBQUEsQ0FBa0JQLFVBQUFBLElBQUk7QUFBQSxhQUFJQSxJQUFJLFlBRDlDLFlBQ3NDO0FBQUEsS0FBdEJPLENBRGhCO0FBRUQ7Ozs7V0FFREMsb0JBQVc7QUFDVCxhQUFBLHFCQUFBLE1BQUEsQ0FBNEIsS0FBNUIsUUFBQSxDQUFBO0FBQ0Q7OztXQUVEQyxvQkFBVztBQUNULFdBQUEsa0JBQUE7O0FBRUEsVUFBTVAsS0FBSyxHQUFHLEtBQWQsWUFBQTs7QUFFQSxVQUFBLEtBQUEsRUFBVztBQUNULGFBQUssSUFBSUMsQ0FBQyxHQUFMLENBQUEsRUFBV0MsQ0FBQyxHQUFHRixLQUFLLENBQXpCLE1BQUEsRUFBa0NDLENBQUMsR0FBbkMsQ0FBQSxFQUF5Q0EsQ0FBekMsRUFBQSxFQUE4QztBQUM1Q0QsVUFBQUEsS0FBSyxDQUFMQSxDQUFLLENBQUxBLENBQUFBLFVBQUFBLENBQUFBLElBQUFBO0FBQ0Q7QUFDRjtBQUNGOzs7V0FFRFEsb0JBQVc7QUFDVCxVQUFNUixLQUFLLEdBQUcsS0FBZCxZQUFBOztBQUVBLFVBQUEsS0FBQSxFQUFXO0FBQ1QsYUFBSyxJQUFJQyxDQUFDLEdBQUwsQ0FBQSxFQUFXQyxDQUFDLEdBQUdGLEtBQUssQ0FBekIsTUFBQSxFQUFrQ0MsQ0FBQyxHQUFuQyxDQUFBLEVBQXlDQSxDQUF6QyxFQUFBLEVBQThDO0FBQzVDRCxVQUFBQSxLQUFLLENBQUxBLENBQUssQ0FBTEEsQ0FBQUEsYUFBQUEsQ0FBQUEsSUFBQUE7QUFDRDtBQUNGOztBQUVELFdBQUEsZ0JBQUE7QUFDRDs7O1dBRURTLHNCQUFhO0FBQ1gsVUFBSSxFQUFFcEIsTUFBTSxJQUFJLEtBQVosWUFBQSxLQUFrQyxLQUFBLFlBQUEsQ0FBQSxNQUFBLElBQXRDLE1BQUEsRUFBMEU7QUFDeEUsYUFBQSxZQUFBLENBQUEsTUFBQSxJQUFBLE1BQUE7O0FBQ0EsWUFBTXFCLE1BQU0sR0FBRyxLQUFmLFlBQWUsRUFBZjs7QUFDQSxhQUFBLGVBQUEsQ0FBQSxNQUFBLElBQUEsTUFBQTtBQUNBLGVBQUEsTUFBQTtBQUNEOztBQUNELGFBQU8sS0FBQSxlQUFBLENBQVAsTUFBTyxDQUFQO0FBQ0Q7OztXQUVEQyw0QkFBa0IsUUFBbEJBLEVBQTZCO0FBQzNCLFdBQUEsZUFBQSxDQUFBLE1BQUEsSUFBQSxRQUFBOztBQUNBLFdBQUEsYUFBQTtBQUNEOzs7V0FFREMsMkNBQWtDO0FBQ2hDLFdBQUEsWUFBQSxDQUFBLE1BQUEsSUFBNEIsQ0FBNUIsQ0FBQTs7QUFDQSxXQUFBLGFBQUE7QUFDRDs7O1dBRURDLHlCQUFnQjtBQUNkNUIsTUFBQUEsYUFBYSxDQUFiQSxJQUFBQSxDQUFBQSxJQUFBQTs7QUFDQSxVQUFJLENBQUosbUJBQUEsRUFBMEI7QUFDeEJFLFFBQUFBLG1CQUFtQixHQUFHZ0IsZUFBZSxDQUFyQ2hCLGNBQXFDLENBQXJDQTtBQUNEO0FBQ0Y7OztXQUVEMkIsOEJBQXFCO0FBQ25CLFVBQUksQ0FBQyxLQUFMLGFBQUEsRUFBeUI7QUFDdkJDLFFBQUFBLGlCQUFBQSxDQUFBQSxPQUFBQSxDQUFBQSxVQUFBQSxDQUE0QixLQUE1QkEsUUFBQUEsRUFBQUEsYUFBQUEsQ0FBQUEsRUFBQUEsRUFBZ0QsS0FBaERBLFlBQUFBLENBQUFBOztBQUNBLGFBQUEsYUFBQSxHQUFBLElBQUE7QUFDRDtBQUNGOzs7V0FFREMsNEJBQW1CO0FBQ2pCLFVBQUksS0FBSixhQUFBLEVBQXdCO0FBQ3RCRCxRQUFBQSxpQkFBQUEsQ0FBQUEsT0FBQUEsQ0FBQUEsUUFBQUEsQ0FBMEIsS0FBMUJBLFFBQUFBOztBQUNBLGFBQUEsYUFBQSxHQUFBLEtBQUE7QUFDRDtBQUNGOzs7V0FFREUsaUNBQXdCO0FBQ3RCLGFBQU8sS0FBUCxhQUFBO0FBQ0Q7OztXQUVEQyx3QkFBZTtBQUNiLFlBQU0sSUFBQSxLQUFBLENBQU4sc0NBQU0sQ0FBTjtBQUNEOzs7V0FFREMsc0JBQWE7QUFDWCxhQUFPLEtBQVAsVUFBTyxFQUFQO0FBQ0Q7OztXQUVEQyx5QkFBZ0I7QUFDZCxhQUFPLEtBQVAsVUFBQTtBQUNEOzs7V0FFREMsb0JBQVUsS0FBVkEsRUFBa0I7QUFDaEIsVUFBSSxLQUFBLFVBQUEsQ0FBQSxNQUFBLEtBQUosQ0FBQSxFQUFrQztBQUNoQyxhQUFBLFFBQUE7QUFDRDs7QUFDRCxXQUFBLFVBQUEsQ0FBQSxJQUFBLENBQUEsS0FBQTs7QUFDQUMsTUFBQUEsS0FBSyxDQUFMQSxrQkFBQUE7O0FBRUEsVUFBSVAsaUJBQUFBLENBQUFBLE9BQUFBLENBQUosWUFBQSxFQUFtQztBQUNqQ0EsUUFBQUEsaUJBQUFBLENBQUFBLE9BQUFBLENBQUFBLFlBQUFBLENBQThCLEtBQTlCQSxRQUFBQSxFQUE2Q08sS0FBSyxDQUFsRFAsUUFBQUE7QUFERixPQUFBLE1BRU87QUFDTE8sUUFBQUEsS0FBSyxDQUFMQSwrQkFBQUE7QUFDRDtBQUNGOzs7V0FFREMsdUJBQWEsS0FBYkEsRUFBcUI7QUFDbkIsVUFBTUMsS0FBSyxHQUFHLEtBQUEsVUFBQSxDQUFBLE9BQUEsQ0FBZCxLQUFjLENBQWQ7O0FBQ0EsVUFBSUEsS0FBSyxLQUFLLENBQWQsQ0FBQSxFQUFrQjtBQUNoQnpCLFFBQUFBLE9BQU8sQ0FBUEEsSUFBQUEsQ0FBQUEsNkNBQUFBO0FBQ0E7QUFDRDs7QUFFRCxVQUFJZ0IsaUJBQUFBLENBQUFBLE9BQUFBLENBQUosZUFBQSxFQUFzQztBQUNwQ0EsUUFBQUEsaUJBQUFBLENBQUFBLE9BQUFBLENBQUFBLGVBQUFBLENBQWlDLEtBQWpDQSxRQUFBQSxFQUFnRE8sS0FBSyxDQUFyRFAsUUFBQUE7QUFDRDs7QUFFRCxXQUFBLFVBQUEsQ0FBQSxNQUFBLENBQUEsS0FBQSxFQUFBLENBQUE7O0FBQ0EsVUFBSSxLQUFBLFVBQUEsQ0FBQSxNQUFBLEtBQUosQ0FBQSxFQUFrQztBQUNoQyxhQUFBLFFBQUE7QUFDRDtBQUNGOzs7V0FFRFUsOEJBQW9CLGFBQXBCQSxFQUFvQztBQUNsQyxVQUFJVixpQkFBQUEsQ0FBQUEsT0FBQUEsQ0FBSixpQkFBQSxFQUF3QztBQUN0Q0EsUUFBQUEsaUJBQUFBLENBQUFBLE9BQUFBLENBQUFBLGlCQUFBQSxDQUFtQyxLQUFuQ0EsUUFBQUEsRUFBQUEsYUFBQUE7QUFERixPQUFBLE1BRU87QUFDTCxhQUFBLCtCQUFBO0FBQ0Q7QUFDRjs7O1dBRURXLGlDQUF1QixhQUF2QkEsRUFBdUM7QUFDckNYLE1BQUFBLGlCQUFBQSxDQUFBQSxPQUFBQSxDQUFBQSxzQkFBQUEsQ0FBd0MsS0FBeENBLFFBQUFBLEVBQUFBLGFBQUFBO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhbmltYXRlZE1vZHVsZSBmcm9tICcuLi9SZWFuaW1hdGVkTW9kdWxlJztcbmltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAncmVhY3QtbmF0aXZlJztcblxuY29uc3QgVVBEQVRFRF9OT0RFUyA9IFtdO1xuXG5sZXQgbG9vcElEID0gMTtcbmxldCBwcm9wVXBkYXRlc0VucXVldWVkID0gbnVsbDtcbmxldCBub2RlQ291bnQgPSAwO1xubGV0IGNhbGxJRCA9IFwiXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDYWxsSUQoKSB7XG4gIHJldHVybiBjYWxsSUQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRDYWxsSUQobmV4dENhbGxJRCkge1xuICBjYWxsSUQgPSBuZXh0Q2FsbElEO1xufVxuXG5mdW5jdGlvbiBzYW5pdGl6ZUNvbmZpZyhjb25maWcpIHtcbiAgaWYgKFBsYXRmb3JtLk9TID09PSAnd2ViJyB8fCBQbGF0Zm9ybS5PUyA9PT0gJ3dpbmRvd3MnIHx8IFBsYXRmb3JtLk9TID09PSAnbWFjb3MnIHx8IFsndW5kZWZpbmVkJywgJ3N0cmluZycsICdmdW5jdGlvbicsICdib29sZWFuJywgJ251bWJlciddLmluY2x1ZGVzKHR5cGVvZiBjb25maWcpKSB7XG4gICAgcmV0dXJuIGNvbmZpZztcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGNvbmZpZykpIHtcbiAgICByZXR1cm4gY29uZmlnLm1hcChzYW5pdGl6ZUNvbmZpZyk7XG4gIH0gZWxzZSBpZiAoY29uZmlnIGluc3RhbmNlb2YgQW5pbWF0ZWROb2RlKSB7XG4gICAgcmV0dXJuIGNvbmZpZy5fX25vZGVJRDtcbiAgfSBlbHNlIGlmICh0eXBlb2YgY29uZmlnID09PSAnb2JqZWN0Jykge1xuICAgIGNvbnN0IG91dHB1dCA9IHt9O1xuICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gY29uZmlnKSB7XG4gICAgICBpZiAocHJvcGVydHkgaW4gY29uZmlnKSB7XG4gICAgICAgIG91dHB1dFtwcm9wZXJ0eV0gPSBzYW5pdGl6ZUNvbmZpZyhjb25maWdbcHJvcGVydHldKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG91dHB1dDtcbiAgfVxuICAvLyB1bmhhbmRsZWRcbiAgcmV0dXJuIGNvbmZpZztcbn1cblxuZnVuY3Rpb24gcnVuUHJvcFVwZGF0ZXMoKSB7XG4gIGNvbnN0IHZpc2l0ZWROb2RlcyA9IG5ldyBTZXQoKTtcbiAgY29uc3QgZmluZEFuZFVwZGF0ZU5vZGVzID0gbm9kZSA9PiB7XG4gICAgaWYgKCFub2RlKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ2ZpbmRBbmRVcGRhdGVOb2RlcyB3YXMgcGFzc2VkIGEgbnVsbGlzaCBub2RlJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHZpc2l0ZWROb2Rlcy5oYXMobm9kZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2Uge1xuICAgICAgdmlzaXRlZE5vZGVzLmFkZChub2RlKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBub2RlLnVwZGF0ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgbm9kZS51cGRhdGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbm9kZXMgPSBub2RlLl9fZ2V0Q2hpbGRyZW4oKTtcbiAgICAgIGlmIChub2Rlcykge1xuICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IG5vZGVzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgIGZpbmRBbmRVcGRhdGVOb2Rlcyhub2Rlc1tpXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgVVBEQVRFRF9OT0RFUy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IG5vZGUgPSBVUERBVEVEX05PREVTW2ldO1xuICAgIGZpbmRBbmRVcGRhdGVOb2Rlcyhub2RlKTtcbiAgfVxuICBVUERBVEVEX05PREVTLmxlbmd0aCA9IDA7IC8vIGNsZWFyIGFycmF5XG4gIHByb3BVcGRhdGVzRW5xdWV1ZWQgPSBudWxsO1xuICBsb29wSUQgKz0gMTtcbn1cblxuY29uc3Qgc2NoZWR1bGVVcGRhdGVzID1cbiAgUGxhdGZvcm0uT1MgPT09ICd3ZWInID8gcmVxdWVzdEFuaW1hdGlvbkZyYW1lIDogc2V0SW1tZWRpYXRlO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBbmltYXRlZE5vZGUge1xuXG4gIF9fbm9kZUlEO1xuICBfX2xhc3RMb29wSUQgPSB7IFwiXCI6IC0xIH07XG4gIF9fbWVtb2l6ZWRWYWx1ZSA9IHsgXCJcIjogbnVsbCB9O1xuICBfX2NoaWxkcmVuID0gW107XG5cbiAgY29uc3RydWN0b3Iobm9kZUNvbmZpZywgaW5wdXROb2Rlcykge1xuICAgIHRoaXMuX19ub2RlSUQgPSArK25vZGVDb3VudDtcbiAgICB0aGlzLl9fbm9kZUNvbmZpZyA9IHNhbml0aXplQ29uZmlnKG5vZGVDb25maWcpO1xuICAgIHRoaXMuX19pbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIHRoaXMuX19pbnB1dE5vZGVzID1cbiAgICAgIGlucHV0Tm9kZXMgJiYgaW5wdXROb2Rlcy5maWx0ZXIobm9kZSA9PiBub2RlIGluc3RhbmNlb2YgQW5pbWF0ZWROb2RlKTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiBgQW5pbWF0ZWROb2RlLCBpZDogJHt0aGlzLl9fbm9kZUlEfWA7XG4gIH1cblxuICBfX2F0dGFjaCgpIHtcbiAgICB0aGlzLl9fbmF0aXZlSW5pdGlhbGl6ZSgpO1xuXG4gICAgY29uc3Qgbm9kZXMgPSB0aGlzLl9faW5wdXROb2RlcztcblxuICAgIGlmIChub2Rlcykge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBub2Rlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgbm9kZXNbaV0uX19hZGRDaGlsZCh0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBfX2RldGFjaCgpIHtcbiAgICBjb25zdCBub2RlcyA9IHRoaXMuX19pbnB1dE5vZGVzO1xuXG4gICAgaWYgKG5vZGVzKSB7XG4gICAgICBmb3IgKGxldCBpID0gMCwgbCA9IG5vZGVzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICBub2Rlc1tpXS5fX3JlbW92ZUNoaWxkKHRoaXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuX19uYXRpdmVUZWFyRG93bigpO1xuICB9XG5cbiAgX19nZXRWYWx1ZSgpIHtcbiAgICBpZiAoIShjYWxsSUQgaW4gdGhpcy5fX2xhc3RMb29wSUQpIHx8IHRoaXMuX19sYXN0TG9vcElEW2NhbGxJRF0gPCBsb29wSUQpIHtcbiAgICAgIHRoaXMuX19sYXN0TG9vcElEW2NhbGxJRF0gPSBsb29wSUQ7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9fb25FdmFsdWF0ZSgpO1xuICAgICAgdGhpcy5fX21lbW9pemVkVmFsdWVbY2FsbElEXSA9IHJlc3VsdDtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9fbWVtb2l6ZWRWYWx1ZVtjYWxsSURdO1xuICB9XG5cbiAgX19mb3JjZVVwZGF0ZUNhY2hlKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fX21lbW9pemVkVmFsdWVbY2FsbElEXSA9IG5ld1ZhbHVlO1xuICAgIHRoaXMuX19tYXJrVXBkYXRlZCgpO1xuICB9XG5cbiAgX19kYW5nZXJvdXNseVJlc2NoZWR1bGVFdmFsdWF0ZSgpIHtcbiAgICB0aGlzLl9fbGFzdExvb3BJRFtjYWxsSURdID0gLTE7XG4gICAgdGhpcy5fX21hcmtVcGRhdGVkKCk7XG4gIH1cblxuICBfX21hcmtVcGRhdGVkKCkge1xuICAgIFVQREFURURfTk9ERVMucHVzaCh0aGlzKTtcbiAgICBpZiAoIXByb3BVcGRhdGVzRW5xdWV1ZWQpIHtcbiAgICAgIHByb3BVcGRhdGVzRW5xdWV1ZWQgPSBzY2hlZHVsZVVwZGF0ZXMocnVuUHJvcFVwZGF0ZXMpO1xuICAgIH1cbiAgfVxuXG4gIF9fbmF0aXZlSW5pdGlhbGl6ZSgpIHtcbiAgICBpZiAoIXRoaXMuX19pbml0aWFsaXplZCkge1xuICAgICAgUmVhbmltYXRlZE1vZHVsZS5jcmVhdGVOb2RlKHRoaXMuX19ub2RlSUQsIHsgLi4udGhpcy5fX25vZGVDb25maWcgfSk7XG4gICAgICB0aGlzLl9faW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIF9fbmF0aXZlVGVhckRvd24oKSB7XG4gICAgaWYgKHRoaXMuX19pbml0aWFsaXplZCkge1xuICAgICAgUmVhbmltYXRlZE1vZHVsZS5kcm9wTm9kZSh0aGlzLl9fbm9kZUlEKTtcbiAgICAgIHRoaXMuX19pbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGlzTmF0aXZlbHlJbml0aWFsaXplZCgpIHtcbiAgICByZXR1cm4gdGhpcy5fX2luaXRpYWxpemVkO1xuICB9XG5cbiAgX19vbkV2YWx1YXRlKCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBpbXBsZW1lbnRhdGlvbiBvZiBvbkV2YWx1YXRlJyk7XG4gIH1cblxuICBfX2dldFByb3BzKCkge1xuICAgIHJldHVybiB0aGlzLl9fZ2V0VmFsdWUoKTtcbiAgfVxuXG4gIF9fZ2V0Q2hpbGRyZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMuX19jaGlsZHJlbjtcbiAgfVxuXG4gIF9fYWRkQ2hpbGQoY2hpbGQpIHtcbiAgICBpZiAodGhpcy5fX2NoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5fX2F0dGFjaCgpO1xuICAgIH1cbiAgICB0aGlzLl9fY2hpbGRyZW4ucHVzaChjaGlsZCk7XG4gICAgY2hpbGQuX19uYXRpdmVJbml0aWFsaXplKCk7XG5cbiAgICBpZiAoUmVhbmltYXRlZE1vZHVsZS5jb25uZWN0Tm9kZXMpIHtcbiAgICAgIFJlYW5pbWF0ZWRNb2R1bGUuY29ubmVjdE5vZGVzKHRoaXMuX19ub2RlSUQsIGNoaWxkLl9fbm9kZUlEKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2hpbGQuX19kYW5nZXJvdXNseVJlc2NoZWR1bGVFdmFsdWF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIF9fcmVtb3ZlQ2hpbGQoY2hpbGQpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuX19jaGlsZHJlbi5pbmRleE9mKGNoaWxkKTtcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJUcnlpbmcgdG8gcmVtb3ZlIGEgY2hpbGQgdGhhdCBkb2Vzbid0IGV4aXN0XCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChSZWFuaW1hdGVkTW9kdWxlLmRpc2Nvbm5lY3ROb2Rlcykge1xuICAgICAgUmVhbmltYXRlZE1vZHVsZS5kaXNjb25uZWN0Tm9kZXModGhpcy5fX25vZGVJRCwgY2hpbGQuX19ub2RlSUQpO1xuICAgIH1cblxuICAgIHRoaXMuX19jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIGlmICh0aGlzLl9fY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLl9fZGV0YWNoKCk7XG4gICAgfVxuICB9XG5cbiAgX2Nvbm5lY3RBbmltYXRlZFZpZXcobmF0aXZlVmlld1RhZykge1xuICAgIGlmIChSZWFuaW1hdGVkTW9kdWxlLmNvbm5lY3ROb2RlVG9WaWV3KSB7XG4gICAgICBSZWFuaW1hdGVkTW9kdWxlLmNvbm5lY3ROb2RlVG9WaWV3KHRoaXMuX19ub2RlSUQsIG5hdGl2ZVZpZXdUYWcpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9fZGFuZ2Vyb3VzbHlSZXNjaGVkdWxlRXZhbHVhdGUoKTtcbiAgICB9XG4gIH1cblxuICBfZGlzY29ubmVjdEFuaW1hdGVkVmlldyhuYXRpdmVWaWV3VGFnKSB7XG4gICAgUmVhbmltYXRlZE1vZHVsZS5kaXNjb25uZWN0Tm9kZUZyb21WaWV3KHRoaXMuX19ub2RlSUQsIG5hdGl2ZVZpZXdUYWcpO1xuICB9XG59XG4iXX0=
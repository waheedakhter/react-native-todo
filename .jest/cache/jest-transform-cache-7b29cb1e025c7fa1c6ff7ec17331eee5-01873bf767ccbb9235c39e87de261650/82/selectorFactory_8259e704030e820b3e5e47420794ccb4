95ba896c44106cbfef9cbf76ff5c91c1
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault")["default"];

exports.__esModule = true;
exports["default"] = finalPropsSelectorFactory;
exports.impureFinalPropsSelectorFactory = impureFinalPropsSelectorFactory;
exports.pureFinalPropsSelectorFactory = pureFinalPropsSelectorFactory;

var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));

var _verifySubselectors = _interopRequireDefault(require("./verifySubselectors"));

var _excluded = ["initMapStateToProps", "initMapDispatchToProps", "initMergeProps"];

function impureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch) {
  return function impureFinalPropsSelector(state, ownProps) {
    return mergeProps(mapStateToProps(state, ownProps), mapDispatchToProps(dispatch, ownProps), ownProps);
  };
}

function pureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, _ref) {
  var areStatesEqual = _ref.areStatesEqual,
      areOwnPropsEqual = _ref.areOwnPropsEqual,
      areStatePropsEqual = _ref.areStatePropsEqual;
  var hasRunAtLeastOnce = false;
  var state;
  var ownProps;
  var stateProps;
  var dispatchProps;
  var mergedProps;

  function handleFirstCall(firstState, firstOwnProps) {
    state = firstState;
    ownProps = firstOwnProps;
    stateProps = mapStateToProps(state, ownProps);
    dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    hasRunAtLeastOnce = true;
    return mergedProps;
  }

  function handleNewPropsAndNewState() {
    stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewProps() {
    if (mapStateToProps.dependsOnOwnProps) stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewState() {
    var nextStateProps = mapStateToProps(state, ownProps);
    var statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps);
    stateProps = nextStateProps;
    if (statePropsChanged) mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleSubsequentCalls(nextState, nextOwnProps) {
    var propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps);
    var stateChanged = !areStatesEqual(nextState, state);
    state = nextState;
    ownProps = nextOwnProps;
    if (propsChanged && stateChanged) return handleNewPropsAndNewState();
    if (propsChanged) return handleNewProps();
    if (stateChanged) return handleNewState();
    return mergedProps;
  }

  return function pureFinalPropsSelector(nextState, nextOwnProps) {
    return hasRunAtLeastOnce ? handleSubsequentCalls(nextState, nextOwnProps) : handleFirstCall(nextState, nextOwnProps);
  };
}

function finalPropsSelectorFactory(dispatch, _ref2) {
  var initMapStateToProps = _ref2.initMapStateToProps,
      initMapDispatchToProps = _ref2.initMapDispatchToProps,
      initMergeProps = _ref2.initMergeProps,
      options = (0, _objectWithoutPropertiesLoose2["default"])(_ref2, _excluded);
  var mapStateToProps = initMapStateToProps(dispatch, options);
  var mapDispatchToProps = initMapDispatchToProps(dispatch, options);
  var mergeProps = initMergeProps(dispatch, options);

  if (process.env.NODE_ENV !== 'production') {
    (0, _verifySubselectors["default"])(mapStateToProps, mapDispatchToProps, mergeProps, options.displayName);
  }

  var selectorFactory = options.pure ? pureFinalPropsSelectorFactory : impureFinalPropsSelectorFactory;
  return selectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, options);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbGVjdG9yRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsImltcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkiLCJwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsIl9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMiIsIl92ZXJpZnlTdWJzZWxlY3RvcnMiLCJfZXhjbHVkZWQiLCJtYXBTdGF0ZVRvUHJvcHMiLCJtYXBEaXNwYXRjaFRvUHJvcHMiLCJtZXJnZVByb3BzIiwiZGlzcGF0Y2giLCJpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3IiLCJzdGF0ZSIsIm93blByb3BzIiwiX3JlZiIsImFyZVN0YXRlc0VxdWFsIiwiYXJlT3duUHJvcHNFcXVhbCIsImFyZVN0YXRlUHJvcHNFcXVhbCIsImhhc1J1bkF0TGVhc3RPbmNlIiwic3RhdGVQcm9wcyIsImRpc3BhdGNoUHJvcHMiLCJtZXJnZWRQcm9wcyIsImhhbmRsZUZpcnN0Q2FsbCIsImZpcnN0U3RhdGUiLCJmaXJzdE93blByb3BzIiwiaGFuZGxlTmV3UHJvcHNBbmROZXdTdGF0ZSIsImRlcGVuZHNPbk93blByb3BzIiwiaGFuZGxlTmV3UHJvcHMiLCJoYW5kbGVOZXdTdGF0ZSIsIm5leHRTdGF0ZVByb3BzIiwic3RhdGVQcm9wc0NoYW5nZWQiLCJoYW5kbGVTdWJzZXF1ZW50Q2FsbHMiLCJuZXh0U3RhdGUiLCJuZXh0T3duUHJvcHMiLCJwcm9wc0NoYW5nZWQiLCJzdGF0ZUNoYW5nZWQiLCJwdXJlRmluYWxQcm9wc1NlbGVjdG9yIiwiX3JlZjIiLCJpbml0TWFwU3RhdGVUb1Byb3BzIiwiaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyIsImluaXRNZXJnZVByb3BzIiwib3B0aW9ucyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImRpc3BsYXlO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ZmF1bHQgPSByZXF1aXJlKFwiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbnRlcm9wUmVxdWlyZURlZmF1bHRcIilbXCJkZWZhdWx0XCJdO1xuXG5leHBvcnRzLl9fZXNNb2R1bGUgPSB0cnVlO1xuZXhwb3J0c1tcImRlZmF1bHRcIl0gPSBmaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5O1xuZXhwb3J0cy5pbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5ID0gaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeTtcbmV4cG9ydHMucHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkgPSBwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeTtcblxudmFyIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZVwiKSk7XG5cbnZhciBfdmVyaWZ5U3Vic2VsZWN0b3JzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi92ZXJpZnlTdWJzZWxlY3RvcnNcIikpO1xuXG52YXIgX2V4Y2x1ZGVkID0gW1wiaW5pdE1hcFN0YXRlVG9Qcm9wc1wiLCBcImluaXRNYXBEaXNwYXRjaFRvUHJvcHNcIiwgXCJpbml0TWVyZ2VQcm9wc1wiXTtcblxuZnVuY3Rpb24gaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgZGlzcGF0Y2gpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIGltcHVyZUZpbmFsUHJvcHNTZWxlY3RvcihzdGF0ZSwgb3duUHJvcHMpIHtcbiAgICByZXR1cm4gbWVyZ2VQcm9wcyhtYXBTdGF0ZVRvUHJvcHMoc3RhdGUsIG93blByb3BzKSwgbWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvd25Qcm9wcyksIG93blByb3BzKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkobWFwU3RhdGVUb1Byb3BzLCBtYXBEaXNwYXRjaFRvUHJvcHMsIG1lcmdlUHJvcHMsIGRpc3BhdGNoLCBfcmVmKSB7XG4gIHZhciBhcmVTdGF0ZXNFcXVhbCA9IF9yZWYuYXJlU3RhdGVzRXF1YWwsXG4gICAgICBhcmVPd25Qcm9wc0VxdWFsID0gX3JlZi5hcmVPd25Qcm9wc0VxdWFsLFxuICAgICAgYXJlU3RhdGVQcm9wc0VxdWFsID0gX3JlZi5hcmVTdGF0ZVByb3BzRXF1YWw7XG4gIHZhciBoYXNSdW5BdExlYXN0T25jZSA9IGZhbHNlO1xuICB2YXIgc3RhdGU7XG4gIHZhciBvd25Qcm9wcztcbiAgdmFyIHN0YXRlUHJvcHM7XG4gIHZhciBkaXNwYXRjaFByb3BzO1xuICB2YXIgbWVyZ2VkUHJvcHM7XG5cbiAgZnVuY3Rpb24gaGFuZGxlRmlyc3RDYWxsKGZpcnN0U3RhdGUsIGZpcnN0T3duUHJvcHMpIHtcbiAgICBzdGF0ZSA9IGZpcnN0U3RhdGU7XG4gICAgb3duUHJvcHMgPSBmaXJzdE93blByb3BzO1xuICAgIHN0YXRlUHJvcHMgPSBtYXBTdGF0ZVRvUHJvcHMoc3RhdGUsIG93blByb3BzKTtcbiAgICBkaXNwYXRjaFByb3BzID0gbWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvd25Qcm9wcyk7XG4gICAgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzKHN0YXRlUHJvcHMsIGRpc3BhdGNoUHJvcHMsIG93blByb3BzKTtcbiAgICBoYXNSdW5BdExlYXN0T25jZSA9IHRydWU7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlTmV3UHJvcHNBbmROZXdTdGF0ZSgpIHtcbiAgICBzdGF0ZVByb3BzID0gbWFwU3RhdGVUb1Byb3BzKHN0YXRlLCBvd25Qcm9wcyk7XG4gICAgaWYgKG1hcERpc3BhdGNoVG9Qcm9wcy5kZXBlbmRzT25Pd25Qcm9wcykgZGlzcGF0Y2hQcm9wcyA9IG1hcERpc3BhdGNoVG9Qcm9wcyhkaXNwYXRjaCwgb3duUHJvcHMpO1xuICAgIG1lcmdlZFByb3BzID0gbWVyZ2VQcm9wcyhzdGF0ZVByb3BzLCBkaXNwYXRjaFByb3BzLCBvd25Qcm9wcyk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlTmV3UHJvcHMoKSB7XG4gICAgaWYgKG1hcFN0YXRlVG9Qcm9wcy5kZXBlbmRzT25Pd25Qcm9wcykgc3RhdGVQcm9wcyA9IG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpO1xuICAgIGlmIChtYXBEaXNwYXRjaFRvUHJvcHMuZGVwZW5kc09uT3duUHJvcHMpIGRpc3BhdGNoUHJvcHMgPSBtYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG93blByb3BzKTtcbiAgICBtZXJnZWRQcm9wcyA9IG1lcmdlUHJvcHMoc3RhdGVQcm9wcywgZGlzcGF0Y2hQcm9wcywgb3duUHJvcHMpO1xuICAgIHJldHVybiBtZXJnZWRQcm9wcztcbiAgfVxuXG4gIGZ1bmN0aW9uIGhhbmRsZU5ld1N0YXRlKCkge1xuICAgIHZhciBuZXh0U3RhdGVQcm9wcyA9IG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpO1xuICAgIHZhciBzdGF0ZVByb3BzQ2hhbmdlZCA9ICFhcmVTdGF0ZVByb3BzRXF1YWwobmV4dFN0YXRlUHJvcHMsIHN0YXRlUHJvcHMpO1xuICAgIHN0YXRlUHJvcHMgPSBuZXh0U3RhdGVQcm9wcztcbiAgICBpZiAoc3RhdGVQcm9wc0NoYW5nZWQpIG1lcmdlZFByb3BzID0gbWVyZ2VQcm9wcyhzdGF0ZVByb3BzLCBkaXNwYXRjaFByb3BzLCBvd25Qcm9wcyk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlU3Vic2VxdWVudENhbGxzKG5leHRTdGF0ZSwgbmV4dE93blByb3BzKSB7XG4gICAgdmFyIHByb3BzQ2hhbmdlZCA9ICFhcmVPd25Qcm9wc0VxdWFsKG5leHRPd25Qcm9wcywgb3duUHJvcHMpO1xuICAgIHZhciBzdGF0ZUNoYW5nZWQgPSAhYXJlU3RhdGVzRXF1YWwobmV4dFN0YXRlLCBzdGF0ZSk7XG4gICAgc3RhdGUgPSBuZXh0U3RhdGU7XG4gICAgb3duUHJvcHMgPSBuZXh0T3duUHJvcHM7XG4gICAgaWYgKHByb3BzQ2hhbmdlZCAmJiBzdGF0ZUNoYW5nZWQpIHJldHVybiBoYW5kbGVOZXdQcm9wc0FuZE5ld1N0YXRlKCk7XG4gICAgaWYgKHByb3BzQ2hhbmdlZCkgcmV0dXJuIGhhbmRsZU5ld1Byb3BzKCk7XG4gICAgaWYgKHN0YXRlQ2hhbmdlZCkgcmV0dXJuIGhhbmRsZU5ld1N0YXRlKCk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIHB1cmVGaW5hbFByb3BzU2VsZWN0b3IobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpIHtcbiAgICByZXR1cm4gaGFzUnVuQXRMZWFzdE9uY2UgPyBoYW5kbGVTdWJzZXF1ZW50Q2FsbHMobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpIDogaGFuZGxlRmlyc3RDYWxsKG5leHRTdGF0ZSwgbmV4dE93blByb3BzKTtcbiAgfTtcbn0gLy8gVE9ETzogQWRkIG1vcmUgY29tbWVudHNcbi8vIElmIHB1cmUgaXMgdHJ1ZSwgdGhlIHNlbGVjdG9yIHJldHVybmVkIGJ5IHNlbGVjdG9yRmFjdG9yeSB3aWxsIG1lbW9pemUgaXRzIHJlc3VsdHMsXG4vLyBhbGxvd2luZyBjb25uZWN0QWR2YW5jZWQncyBzaG91bGRDb21wb25lbnRVcGRhdGUgdG8gcmV0dXJuIGZhbHNlIGlmIGZpbmFsXG4vLyBwcm9wcyBoYXZlIG5vdCBjaGFuZ2VkLiBJZiBmYWxzZSwgdGhlIHNlbGVjdG9yIHdpbGwgYWx3YXlzIHJldHVybiBhIG5ld1xuLy8gb2JqZWN0IGFuZCBzaG91bGRDb21wb25lbnRVcGRhdGUgd2lsbCBhbHdheXMgcmV0dXJuIHRydWUuXG5cblxuZnVuY3Rpb24gZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeShkaXNwYXRjaCwgX3JlZjIpIHtcbiAgdmFyIGluaXRNYXBTdGF0ZVRvUHJvcHMgPSBfcmVmMi5pbml0TWFwU3RhdGVUb1Byb3BzLFxuICAgICAgaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyA9IF9yZWYyLmluaXRNYXBEaXNwYXRjaFRvUHJvcHMsXG4gICAgICBpbml0TWVyZ2VQcm9wcyA9IF9yZWYyLmluaXRNZXJnZVByb3BzLFxuICAgICAgb3B0aW9ucyA9ICgwLCBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTJbXCJkZWZhdWx0XCJdKShfcmVmMiwgX2V4Y2x1ZGVkKTtcbiAgdmFyIG1hcFN0YXRlVG9Qcm9wcyA9IGluaXRNYXBTdGF0ZVRvUHJvcHMoZGlzcGF0Y2gsIG9wdGlvbnMpO1xuICB2YXIgbWFwRGlzcGF0Y2hUb1Byb3BzID0gaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyhkaXNwYXRjaCwgb3B0aW9ucyk7XG4gIHZhciBtZXJnZVByb3BzID0gaW5pdE1lcmdlUHJvcHMoZGlzcGF0Y2gsIG9wdGlvbnMpO1xuXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgKDAsIF92ZXJpZnlTdWJzZWxlY3RvcnNbXCJkZWZhdWx0XCJdKShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgb3B0aW9ucy5kaXNwbGF5TmFtZSk7XG4gIH1cblxuICB2YXIgc2VsZWN0b3JGYWN0b3J5ID0gb3B0aW9ucy5wdXJlID8gcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkgOiBpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5O1xuICByZXR1cm4gc2VsZWN0b3JGYWN0b3J5KG1hcFN0YXRlVG9Qcm9wcywgbWFwRGlzcGF0Y2hUb1Byb3BzLCBtZXJnZVByb3BzLCBkaXNwYXRjaCwgb3B0aW9ucyk7XG59Il19